<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZAP 标签打印</title>
    <style>
        body {
            margin: 0;
            padding: 5px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #007bff;
            color: white;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .settings-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .page {
            padding: 8px;
        }
        
        .page.active {
            display: block;
        }
        
        .scan-section {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .scan-section h3 {
            margin-top: 0;
            color: #666;
        }
        
        .scan-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .scan-input-container input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ccc;
            border-radius: 5px;
            font-size: 18px;
            font-family: monospace;
            text-align: center;
            box-sizing: border-box;
        }
        
        .scan-input-container input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .scan-input-container button {
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .scan-input-container button:hover {
            background: #0056b3;
        }
        
        .error-section {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 3px;
            border: 1px solid #f5c6cb;
            font-size: 14px;
        }
        
        .error-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .error-icon {
            font-size: 1.2rem;
        }
        
        .error-close {
            background: none;
            border: none;
            color: #721c24;
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: auto;
        }
        
        .query-result-section {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #28a745;
            border-radius: 5px;
            background: #d4edda;
        }
        
        .query-result-section h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #155724;
            font-size: 1rem;
        }
        
        .query-result-content {
            font-size: 14px;
            color: #155724;
        }
        
        .query-result-item {
            margin: 5px 0;
            padding: 5px;
            background: rgba(255,255,255,0.5);
            border-radius: 3px;
        }
        
        .query-result-label {
            font-weight: bold;
            display: inline-block;
            min-width: 80px;
        }
        
        
        .status-indicators {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .status-icon {
            font-size: 1rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background: #28a745;
        }
        
        .status-dot.offline {
            background: #dc3545;
        }
        
        .settings-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #ddd;
        }
        
        .settings-header h2 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .tab-nav {
            display: flex;
            margin-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-btn {
            flex: 1;
            padding: 8px;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 13px;
            color: #666;
        }
        
        .tab-btn.active {
            background: white;
            color: #007bff;
            border-bottom-color: #007bff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .settings-section {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-header h3 {
            margin: 0;
            color: #666;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 8px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .form-actions button {
            flex: 1;
            min-width: 100px;
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .form-actions button:hover {
            background: #0056b3;
        }
        
        .label-group-info {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .group-name, .group-description, .group-stats {
            margin: 3px 0;
        }
        
        .label-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .label-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-family: monospace;
        }
        
        .label-item:last-child {
            border-bottom: none;
        }
        
        .label-barcode {
            font-weight: bold;
            color: #333;
        }
        
        .label-count {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .label-count.available {
            background: #d4edda;
            color: #155724;
        }
        
        .label-count.unlimited {
            background: #cce5ff;
            color: #004085;
        }
        
        .label-count.empty {
            background: #f8d7da;
            color: #721c24;
        }
        
        .label-empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .label {
            font-weight: bold;
            min-width: 80px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-dot.online {
            background: #28a745;
        }
        
        .status-dot.offline {
            background: #dc3545;
        }
        
        .cache-status {
            margin: 12px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        
        .cache-info {
            font-size: 0.9rem;
            color: #666;
        }
        
        .cache-info div {
            margin: 5px 0;
        }
        
        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .form-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>EZAP 标签打印</h1>
            <button class="settings-btn" id="topRightBtn" onclick="openPrintPage()" title="返回">返回</button>
        </div>
        
        <!-- 设置页面 -->
        <div id="settingsPage" class="page active" style="display: block;">
            <!-- Tab导航 -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="if(window.PrinterInterface){window.PrinterInterface.switchTab('printer');}" title="打印机设置">打印机</button>
                <button class="tab-btn" onclick="if(window.PrinterInterface){window.PrinterInterface.switchTab('label');}" title="标签设置">标签</button>
                <button class="tab-btn" onclick="if(window.PrinterInterface){window.PrinterInterface.switchTab('template');}" title="模板设置">模板</button>
            </div>
            
            
            <!-- 打印机设置Tab -->
            <div id="printerTab" class="tab-content active">
                <div class="settings-section">
                    <div class="section-header">
                        <h3>打印机设置</h3>
                        <div class="status-indicator">
                            <div id="printerStatusIndicator" class="status-dot offline"></div>
                            <span id="printerStatusText">未连接</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>打印机IP地址:</label>
                        <input type="text" id="printerIp" placeholder="192.168.1.100" value="192.168.1.100">
                    </div>
                    <div class="form-group">
                        <label>端口号:</label>
                        <input type="number" id="printerPort" placeholder="9100" value="9100">
                    </div>
                    <div class="form-actions">
                        <button onclick="testPrinter()" id="testPrinterBtn">测试连接</button>
                        <button onclick="savePrinterConfig()" id="savePrinterBtn">保存配置</button>
                        <button onclick="printTestPage()" id="printTestBtn" disabled>测试打印</button>
                    </div>
                </div>
            </div>
            
            <!-- 标签设置Tab -->
            <div id="labelTab" class="tab-content">
                <div class="settings-section">
                    <div class="section-header">
                        <h3>标签组设置</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>选择标签组:</label>
                        <select id="labelGroupSelect" onchange="onLabelGroupChange()">
                            <option value="">请选择标签组</option>
                        </select>
                    </div>
                    
                    <div id="labelGroupInfo" class="label-group-info" style="display: none;">
                        <div class="group-name">当前选择: <span id="currentGroupName">-</span></div>
                        <div class="group-description">描述: <span id="groupDescription">-</span></div>
                        <div class="group-stats">标签数量: <span id="labelCount">0</span> | 待同步: <span id="pendingSync">0</span>条</div>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="refreshLabelGroups()" id="refreshBtn">刷新标签组</button>
                        <button onclick="syncToServer()" id="syncBtn" disabled>同步服务器</button>
                    </div>
                </div>
                
                <!-- 缓存管理区域 -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3>缓存管理</h3>
                        <div class="status-indicator">
                            <div id="cacheStatusIndicator" class="status-dot offline"></div>
                            <span id="cacheStatusText">未缓存</span>
                        </div>
                    </div>
                    
                    
                    
                    <div class="cache-status">
                        <div class="cache-info">
                            <div>标签数据缓存: <span id="labelDataCacheStatus">未缓存</span></div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="refreshCache('labelData')" id="refreshLabelDataBtn">刷新标签数据缓存</button>
                        <button onclick="clearCache('all')" id="clearCacheBtn">清除所有缓存</button>
                    </div>
                </div>
                
            </div>
            
            <!-- 模板设置Tab -->
            <div id="templateTab" class="tab-content">
                <div class="settings-section">
                    <div class="section-header">
                        <h3>打印模板设置</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>模板名称:</label>
                        <input type="text" id="templateName" placeholder="ZP621标准模板" value="ZP621标准模板">
                    </div>
                    
                    <div class="form-group">
                        <label>模板内容 (ZPL代码):</label>
                        <textarea id="templateContent" rows="15" style="width: 100%; font-family: monospace; font-size: 12px; padding: 8px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box;">^XA
^PW400
^LL300
^CF0,20

; === 条码区域（居中） ===
^FO40,20
^BY2,2,100
^BCN,100,Y,N,N
^FD{{barcode}}^FS

; === 产品描述（左对齐，自动换行多行） ===
^CFA,20
^FO60,200
^FB320,4,0,L,0
^FD{{product_description}}^FS

; === 固定状态行（左对齐） ===
^CF0,22
^FO60,280^FDNew^FS

^XZ</textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="saveTemplate()" id="saveTemplateBtn">保存模板</button>
                        <button onclick="loadTemplate()" id="loadTemplateBtn">加载模板</button>
                        <button onclick="testTemplate()" id="testTemplateBtn">测试模板</button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="section-header">
                        <h3>模板变量说明</h3>
                    </div>
                    <div style="font-size: 14px; color: #666; line-height: 1.5;">
                        <p><strong>可用变量:</strong></p>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li><code>{{barcode}}</code> - 新条码</li>
                            <li><code>{{product_description}}</code> - 产品描述</li>
                            <li><code>{{product_name}}</code> - 产品名称</li>
                        </ul>
                        <p><strong>模板说明:</strong></p>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>标签尺寸: 600x450 点</li>
                            <li>条码类型: Code128</li>
                            <li>产品描述支持自动换行（最多2行）</li>
                            <li>状态固定显示为"New"</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
    </div>

    <script>
        // 返回打印页面
        function openPrintPage() {
            // 跳转回打印页面
            window.location.href = 'file:///android_asset/print.html';
        }
        
        // 页面切换功能（index.html 只用于设置页面）
        function togglePage() {
            // index.html 现在只用于设置页面，不需要切换功能
        }
        
        // 页面切换功能
        function showSettings() {
            const settingsPage = document.getElementById('settingsPage');
            if (settingsPage) {
                settingsPage.style.display = 'block';
            }
        }
        
        function showBusiness() {
            // index.html 只用于设置页面，不需要业务页面功能
        }
        
        // 全局变量
        let printerConnected = false;
        
        // 标签组相关变量
        let labelGroups = [];
        let selectedLabelGroup = null;
        let labelGroupsCache = {};
        let pendingUpdates = [];
        
        // 模板相关变量
        let currentTemplate = null;
        
        function showStatus(message, isSuccess) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isSuccess ? 'success' : 'error');
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }
        
        function updateStatusDisplay() {
            // index.html 只用于设置页面，不需要更新业务页面的状态显示
        }
        
        function testPrinter() {
            const ip = document.getElementById('printerIp').value;
            const port = document.getElementById('printerPort').value;
            
            if (!ip || !port) {
                showStatus('请填写完整的打印机信息', false);
                return;
            }
            
            testPrinterWithConfig(ip, port);
        }
        
        function testPrinterWithConfig(ip, port) {
            showStatus('正在测试连接...', true);
            
            // 使用Android接口测试连接
            if (window.PrinterInterface && window.PrinterInterface.testPrinterConnection) {
                try {
                    window.PrinterInterface.testPrinterConnection(ip, port);
                } catch (error) {
                    showStatus('调用打印机接口失败: ' + error.message, false);
                }
            } else {
                showStatus('打印机接口不可用', false);
            }
        }
        
        // 打印机测试结果回调
        function onPrinterTestResult(success, message) {
            if (success) {
                printerConnected = true;
                updateStatusDisplay();
                updateSettingsStatus();
                showStatus('打印机连接成功！', true);
            } else {
                printerConnected = false;
                updateStatusDisplay();
                updateSettingsStatus();
                showStatus('打印机连接失败：' + message, false);
            }
        }
        
        // 页面切换功能
        function showSettings() {
            const settingsPage = document.getElementById('settingsPage');
            if (settingsPage) {
                settingsPage.style.display = 'block';
            }
        }
        
        function showBusiness() {
            // 设置页面不需要业务页面功能
        }
        
        // Tab切换功能
        function switchTab(tabName) {
            // 隐藏所有tab内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有tab按钮的active状态
            const allBtns = document.querySelectorAll('.tab-btn');
            allBtns.forEach(btn => btn.classList.remove('active'));
            
            // 显示选中的tab内容
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // 激活选中的tab按钮（通过匹配其onclick目标而非依赖event）
            const targetBtn = document.querySelector(`.tab-btn[onclick*="switchTab('${tabName}')"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // 如果切换到标签tab，更新缓存状态
            if (tabName === 'label') {
                // 恢复标签组选择框的值
                const labelGroupSelect = document.getElementById('labelGroupSelect');
                if (selectedLabelGroup) {
                    labelGroupSelect.value = selectedLabelGroup;
                } else {
                    labelGroupSelect.value = '';
                }
                
                // 检查是否有缓存数据，如果有则更新状态
                let totalLabelCount = 0;
                Object.values(labelGroupsCache).forEach(group => {
                    if (group.labels) {
                        totalLabelCount += Object.keys(group.labels).length;
                    }
                });
                
                const labelDataStatus = document.getElementById('labelDataCacheStatus');
                const cacheIndicator = document.getElementById('cacheStatusIndicator');
                const cacheStatusText = document.getElementById('cacheStatusText');
                
                if (totalLabelCount > 0) {
                    labelDataStatus.textContent = `已缓存 (${totalLabelCount}条标签)`;
                    cacheIndicator.className = 'status-dot online';
                    cacheStatusText.textContent = '已缓存';
                } else {
                    labelDataStatus.textContent = '未缓存';
                    cacheIndicator.className = 'status-dot offline';
                    cacheStatusText.textContent = '未缓存';
                }
            }
        }
        
        // 更新设置页面状态显示
        function updateSettingsStatus() {
            
            // 更新打印机状态
            const printerIndicator = document.getElementById('printerStatusIndicator');
            const printerText = document.getElementById('printerStatusText');
            const printTestBtn = document.getElementById('printTestBtn');
            if (printerConnected) {
                printerIndicator.className = 'status-dot online';
                printerText.textContent = '已连接';
                printTestBtn.disabled = false;
            } else {
                printerIndicator.className = 'status-dot offline';
                printerText.textContent = '未连接';
                printTestBtn.disabled = true;
            }
            
            // 更新标签组状态
        }
        
        // 设置页面功能
        
        async function savePrinterConfig() {
            const ip = document.getElementById('printerIp').value;
            const port = document.getElementById('printerPort').value;
            
            if (!ip || !port) {
                showStatus('请填写完整的打印机信息', false);
                return;
            }
            
            // 保存到本地存储
            localStorage.setItem('printerConfig', JSON.stringify({ip, port}));
            showStatus('打印机配置保存成功！', true);
            updateSettingsStatus();
            
            // 自动测试连接
            await testPrinter();
        }
        
        function saveLabelConfig() {
            const width = document.getElementById('labelWidth').value;
            const height = document.getElementById('labelHeight').value;
            const density = document.getElementById('printDensity').value;
            
            if (!width || !height) {
                showStatus('请填写完整的标签信息', false);
                return;
            }
            
            // 保存到本地存储
            localStorage.setItem('labelConfig', JSON.stringify({width, height, density}));
            showStatus('标签配置保存成功！', true);
            updateSettingsStatus();
        }
        
        function printTestPage() {
            if (!printerConnected) {
                showStatus('打印机未连接', false);
                return;
            }
            
            const printBtn = document.getElementById('printTestBtn');
            printBtn.disabled = true;
            printBtn.textContent = '打印中...';
            
            showStatus('正在打印测试页...', true);
            
            // 生成测试页 ZPL 代码
            const testZPL = `^XA
^FO50,50^ADN,36,20^FD测试页打印^FS
^FO50,100^ADN,18,10^FD时间: ${new Date().toLocaleString()}^FS
^FO50,130^ADN,18,10^FD打印机IP: ${document.getElementById('printerIp').value}^FS
^FO50,160^ADN,18,10^FD端口: ${document.getElementById('printerPort').value}^FS
^FO50,190^ADN,18,10^FD连接状态: 正常^FS
^FO50,220^ADN,18,10^FD测试条码: 123456789^FS
^FO50,250^BY3
^BCN,100,Y,N,N
^FD123456789^FS
^XZ`;
            
            // 发送到打印机
            sendToPrinter(testZPL);
            
            // 恢复按钮状态
            setTimeout(() => {
                printBtn.disabled = false;
                printBtn.textContent = '测试打印';
            }, 3000);
        }
        
        // 标签组相关API
        function fetchLabelGroups() {
            // 使用Android接口获取标签组
            if (window.PrinterInterface && window.PrinterInterface.fetchLabelGroups) {
                try {
                    window.PrinterInterface.fetchLabelGroups();
                } catch (error) {
                    showStatus('调用获取标签组接口失败: ' + error.message, false);
                }
            } else {
                showStatus('获取标签组接口不可用', false);
            }
        }
        
        // 接收标签组数据的回调函数
        function onLabelGroupsReceived(dataJson) {
            try {
                const data = JSON.parse(dataJson);
                var recordCount = (data && data.data && Array.isArray(data.data.records)) ? data.data.records.length : 0;
                
                if (data.success) {
                    // 按标签组字段分组，并检查每个分组是否有可打印记录（标签数量 > 打印数量）
                    const groupMap = new Map();
                    data.data.records.forEach(record => {
                        const groupName = record.fields['标签组'];
                        if (!groupName) return;
                        
                        // 计算该记录是否可打印：标签数量（换标数量）> 打印数量
                        // 如果标签数量为空，认为是0；如果打印数量为空，也认为是0
                        const limitNum = (record.fields['换标数量'] == null || record.fields['换标数量'] === '' || isNaN(Number(record.fields['换标数量']))) ? 0 : Number(record.fields['换标数量']);
                        // 兼容字段名：优先"打印数量"，其次"打印次数"
                        const printedRaw = (record.fields.hasOwnProperty('打印数量') ? record.fields['打印数量'] : record.fields['打印次数']);
                        // 处理打印数量为空的情况：如果为 null、undefined、空字符串或 NaN，都认为是 0
                        const printedNum = (printedRaw == null || printedRaw === undefined || printedRaw === '' || isNaN(Number(printedRaw))) ? 0 : Number(printedRaw);
                        const canPrint = limitNum > printedNum;
                        
                        if (!groupMap.has(groupName)) {
                            // 初始化分组，标记为不可打印（如果有至少一条可打印记录，会更新为true）
                            groupMap.set(groupName, {
                                id: groupName,
                                name: groupName,
                                description: `标签组: ${groupName}`,
                                hasPrintableRecords: canPrint
                            });
                        } else {
                            // 如果当前分组还没有可打印记录，检查这条记录是否可打印
                            const group = groupMap.get(groupName);
                            if (!group.hasPrintableRecords && canPrint) {
                                group.hasPrintableRecords = true;
                            }
                        }
                    });
                    
                    // 过滤掉没有可打印记录的分组（标签数量 <= 打印数量的分组）
                    labelGroups = Array.from(groupMap.values()).filter(group => group.hasPrintableRecords);
                    // 移除临时属性
                    labelGroups.forEach(group => delete group.hasPrintableRecords);
                    
                    updateLabelGroupSelect();
                    
                    // 恢复刷新按钮状态
                    const refreshBtn = document.getElementById('refreshBtn');
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.textContent = '刷新标签组';
                    }
                    
                    showStatus('标签组获取成功！', true);
                } else {
                    throw new Error(data.message || '获取标签组失败');
                }
            } catch (error) {
                showStatus('处理标签组数据失败: ' + error.message, false);
                
                // 即使出错也要恢复刷新按钮状态
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = '刷新标签组';
                }
            }
        }
        
        // 标签组获取失败的回调函数
        function onLabelGroupsError(errorMsg) {
            showStatus('获取标签组失败: ' + errorMsg, false);
            
            // 恢复刷新按钮状态
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.disabled = false;
                refreshBtn.textContent = '刷新标签组';
            }
        }
        
        async function fetchLabelGroupLabels(groupId) {
            try {
                const response = await fetch('https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records?pageSize=100', {
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    // 筛选指定标签组的记录
                    const groupRecords = data.data.records.filter(record => {
                        return record.fields['标签组'] === groupId;
                    });
                    
                    // 保存到缓存
                    var foundGroup = labelGroups.find(function(g){ return g.id === groupId; });
                    labelGroupsCache[groupId] = {
                        name: (foundGroup && foundGroup.name) ? foundGroup.name : '',
                        description: (foundGroup && foundGroup.description) ? foundGroup.description : '',
                        labels: {}
                    };
                    
                    // 处理标签数据
                    groupRecords.forEach(record => {
                        const oldBarcode = record.fields['旧标签'];
                        const newBarcode = record.fields['新标签'];
                        // 数值化：换标数量=上限；打印次数=已打印
                        const limitNum = (record.fields['换标数量'] == null || isNaN(Number(record.fields['换标数量']))) ? 1 : Number(record.fields['换标数量']);
                        // 兼容字段名：优先“打印数量”，其次“打印次数”
                        const printedRaw = (record.fields.hasOwnProperty('打印数量') ? record.fields['打印数量'] : record.fields['打印次数']);
                        const printedNum = (printedRaw == null || isNaN(Number(printedRaw))) ? 0 : Number(printedRaw);
                        const remaining = Math.max(limitNum - printedNum, 0);
                        if (oldBarcode && newBarcode) {
                            labelGroupsCache[groupId].labels[oldBarcode] = {
                                newBarcode: newBarcode,
                                productName: record.fields['产品名称'] || '产品',
                                description: record.fields['产品描述'] || '产品描述',
                                // 兼容现有结构：count 用“剩余数量”，originalCount 用“换标数量”
                                count: remaining,
                                originalCount: limitNum,
                                // 额外存储，供后续逻辑使用
                                printLimit: limitNum,
                                printedCount: printedNum
                            };
                        }
                    });
                    
                    return true;
                } else {
                    showStatus('获取标签数据失败: ' + data.message, false);
                    return false;
                }
            } catch (error) {
                showStatus('获取标签数据失败: ' + error.message, false);
                return false;
            }
        }
        
        async function syncPendingUpdates() {
            if (pendingUpdates.length === 0) return;
            
            try {
                // 直接调用Vika API更新记录
                for (const update of pendingUpdates) {
                    await updateVikaRecord(update);
                }
                
                pendingUpdates = [];
                updatePendingSyncCount();
                showStatus('数据同步成功！', true);
            } catch (error) {
                showStatus('同步失败: ' + error.message, false);
            }
        }
        
        // 直接调用Vika API更新记录
        async function updateVikaRecord(update) {
            try {
                // 先获取记录ID
                const recordId = await findRecordIdByOldBarcode(update.oldBarcode, update.groupId);
                if (!recordId) {
                    throw new Error(`未找到记录: ${update.oldBarcode}`);
                }
                
                // 更新记录
                const response = await fetch(`https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records/${recordId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: update.fields
                    })
                });
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || '更新记录失败');
                }
                
                return true;
            } catch (error) {
                throw error;
            }
        }
        
        // 根据旧条码和标签组查找记录ID
        async function findRecordIdByOldBarcode(oldBarcode, groupId) {
            try {
                const response = await fetch('https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records?pageSize=100', {
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const inputBarcode = (oldBarcode || '').trim().toLowerCase();
                    const inputGroup = (groupId || '').trim();
                    const record = data.data.records.find(record => {
                        const recOld = (record.fields['旧标签'] || '').toString().trim().toLowerCase();
                        const recGroup = (record.fields['标签组'] || '').toString().trim();
                        return recOld === inputBarcode && recGroup === inputGroup;
                    });
                    return record ? record.recordId : null;
                }
                return null;
            } catch (error) {
                return null;
            }
        }
        
        // 标签组选择相关
        function updateLabelGroupSelect() {
            const select = document.getElementById('labelGroupSelect');
            const currentValue = select.value; // 保存当前选中的值
            select.innerHTML = '<option value="">请选择标签组</option>';
            
            labelGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                select.appendChild(option);
            });
            
            // 恢复之前选中的值
            if (currentValue && selectedLabelGroup === currentValue) {
                select.value = currentValue;
            }
        }
        
        async function onLabelGroupChange() {
            const groupId = document.getElementById('labelGroupSelect').value;
            
            if (!groupId) {
                selectedLabelGroup = null;
                localStorage.removeItem('selectedLabelGroup');
                hideLabelGroupInfo();
                return;
            }
            
            // 加载标签组数据
            const success = await fetchLabelGroupLabels(groupId);
            if (success) {
                selectedLabelGroup = groupId;
                // 保存到 localStorage，供 print.html 使用
                localStorage.setItem('selectedLabelGroup', groupId);
                showLabelGroupInfo();
                updateSettingsStatus();
            }
        }
        
        function showLabelGroupInfo() {
            const group = labelGroups.find(g => g.id === selectedLabelGroup);
            const cache = labelGroupsCache[selectedLabelGroup];
            
            if (group && cache) {
                document.getElementById('currentGroupName').textContent = group.name;
                document.getElementById('groupDescription').textContent = group.description;
                document.getElementById('labelCount').textContent = Object.keys(cache.labels).length;
                document.getElementById('pendingSync').textContent = pendingUpdates.length;
                
                document.getElementById('labelGroupInfo').style.display = 'block';
            }
        }
        
        function hideLabelGroupInfo() {
            document.getElementById('labelGroupInfo').style.display = 'none';
        }
        
        
        function updatePendingSyncCount() {
            document.getElementById('pendingSync').textContent = pendingUpdates.length;
            const syncBtn = document.getElementById('syncBtn');
            syncBtn.disabled = pendingUpdates.length === 0;
        }
        
        function refreshLabelGroups() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = '刷新中...';
            
            fetchLabelGroups();
            
            // 10秒后超时恢复按钮状态（正常情况下会在回调中恢复）
            setTimeout(() => {
                if (refreshBtn.disabled) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = '刷新标签组';
                }
            }, 10000);
        }
        
        async function syncToServer() {
            if (pendingUpdates.length === 0) {
                showStatus('没有数据需要同步', true);
                return;
            }
            
            const syncBtn = document.getElementById('syncBtn');
            syncBtn.disabled = true;
            syncBtn.textContent = '同步中...';
            
            showStatus('正在同步到在线表格...', true);
            
            await syncPendingUpdates();
            
            syncBtn.disabled = false;
            syncBtn.textContent = '同步服务器';
        }
        
        function updateLabelCount(oldBarcode, newCount) {
            if (!selectedLabelGroup || !labelGroupsCache[selectedLabelGroup]) {
                return;
            }
            
            const cache = labelGroupsCache[selectedLabelGroup];
            if (cache.labels[oldBarcode]) {
                cache.labels[oldBarcode].count = newCount;
                
                // 如果count变为0，加入待同步队列
                if (newCount === 0 && cache.labels[oldBarcode].originalCount > 0) {
                    // 检查是否已经在待同步队列中
                    const existingIndex = pendingUpdates.findIndex(update => 
                        update.oldBarcode === oldBarcode
                    );
                    
                    if (existingIndex === -1) {
                        pendingUpdates.push({
                            groupId: selectedLabelGroup,
                            oldBarcode: oldBarcode,
                            count: 0
                        });
                    }
                    
                    updatePendingSyncCount();
                }
                
            }
        }
        
        function loadConfigs() {
            // 加载打印机配置
            const printerConfig = localStorage.getItem('printerConfig');
            if (printerConfig) {
                const config = JSON.parse(printerConfig);
                document.getElementById('printerIp').value = config.ip;
                document.getElementById('printerPort').value = config.port;
            }
            
            // 加载标签配置
            const labelConfig = localStorage.getItem('labelConfig');
            if (labelConfig) {
                const config = JSON.parse(labelConfig);
                document.getElementById('labelWidth').value = config.width;
                document.getElementById('labelHeight').value = config.height;
                document.getElementById('printDensity').value = config.density;
            }
        }
        
        // 缓存管理函数 - 已移除server依赖，改为纯前端缓存
        
        async function updateCacheStatus() {
            try {
                // 计算所有标签组中的标签数据总数
                let totalLabelCount = 0;
                Object.values(labelGroupsCache).forEach(group => {
                    if (group.labels) {
                        totalLabelCount += Object.keys(group.labels).length;
                    }
                });
                
                // 更新缓存状态指示器
                const cacheIndicator = document.getElementById('cacheStatusIndicator');
                const cacheStatusText = document.getElementById('cacheStatusText');
                
                if (totalLabelCount > 0) {
                    cacheIndicator.className = 'status-dot online';
                    cacheStatusText.textContent = '已缓存';
                } else {
                    cacheIndicator.className = 'status-dot offline';
                    cacheStatusText.textContent = '未缓存';
                }
                
                // 更新缓存信息
                const labelDataStatus = document.getElementById('labelDataCacheStatus');
                
                if (totalLabelCount > 0) {
                    labelDataStatus.textContent = `已缓存 (${totalLabelCount}条标签)`;
                } else {
                    labelDataStatus.textContent = '未缓存';
                }
            } catch (error) {
            }
        }
        
        function refreshCache(type) {
            try {
                showStatus('正在刷新缓存...', true);
                
                if (type === 'labelData') {
                    // 刷新标签数据缓存 - 重新获取标签组列表
                    fetchLabelGroups();
                    showStatus('正在刷新标签数据缓存...', true);
                    updateCacheStatus();
                } else {
                    // 其他类型的缓存刷新 - 已移除server依赖
                    showStatus('缓存刷新完成', true);
                    updateCacheStatus();
                }
            } catch (error) {
                showStatus('刷新缓存失败: ' + error.message, false);
            }
        }
        
        async function clearCache(type) {
            try {
                showStatus('正在清除缓存...', true);
                
                if (type === 'all') {
                    // 清除本地标签数据缓存，但保留标签组列表和显示
                    labelGroupsCache = {};
                    // 不清空 selectedLabelGroup 和 labelGroups，不清空显示数据
                    showStatus('缓存清除成功！', true);
                    // 立即更新缓存状态显示
                    const labelDataStatus = document.getElementById('labelDataCacheStatus');
                    const cacheIndicator = document.getElementById('cacheStatusIndicator');
                    const cacheStatusText = document.getElementById('cacheStatusText');
                    
                    labelDataStatus.textContent = '未缓存';
                    cacheIndicator.className = 'status-dot offline';
                    cacheStatusText.textContent = '未缓存';
                } else {
                    // 其他类型的缓存清除 - 已移除server依赖
                    showStatus('缓存已清除', true);
                    updateCacheStatus();
                }
            } catch (error) {
                showStatus('清除缓存失败: ' + error.message, false);
            }
        }
        
        // 模板管理函数
        function saveTemplate() {
            const templateName = document.getElementById('templateName').value;
            const templateContent = document.getElementById('templateContent').value;
            
            if (!templateName || !templateContent) {
                showStatus('请填写完整的模板信息', false);
                return;
            }
            
            // 保存到本地存储
            const template = {
                name: templateName,
                content: templateContent,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('printTemplate', JSON.stringify(template));
            currentTemplate = template;
            showStatus('模板保存成功！', true);
        }
        
        function loadTemplate() {
            const savedTemplate = localStorage.getItem('printTemplate');
            if (savedTemplate) {
                const template = JSON.parse(savedTemplate);
                document.getElementById('templateName').value = template.name;
                document.getElementById('templateContent').value = template.content;
                currentTemplate = template;
            } else {
                // 如果没有保存的模板，使用默认模板
                currentTemplate = {
                    name: 'ZP621标准模板',
                    content: document.getElementById('templateContent').value
                };
            }
        }
        
        function testTemplate() {
            if (!currentTemplate) {
                showStatus('请先保存模板', false);
                return;
            }
            
            // 使用测试数据生成ZPL代码
            const testData = {
                barcode: 'TEST123456',
                product_description: '测试产品描述 - 这是一个很长的产品描述用来测试自动换行功能',
                product_name: '测试产品'
            };
            
            const zplCode = generateZPL(currentTemplate.content, testData);
            
            // 显示生成的ZPL代码
            showStatus('测试模板生成成功，请查看控制台日志', true);
            
            // 如果打印机已连接，可以发送测试打印
            if (printerConnected) {
                sendToPrinter(zplCode);
            }
        }
        
        function generateZPL(template, data) {
            let zpl = template;
            
            // 替换变量
            zpl = zpl.replace(/\{\{barcode\}\}/g, data.barcode || '');
            zpl = zpl.replace(/\{\{product_description\}\}/g, data.product_description || '');
            zpl = zpl.replace(/\{\{product_name\}\}/g, data.product_name || '');
            
            return zpl;
        }
        
        function sendToPrinter(zplCode) {
            const ip = document.getElementById('printerIp').value;
            const port = document.getElementById('printerPort').value;
            
            if (!ip || !port) {
                showStatus('请先配置打印机IP和端口', false);
                return;
            }
            
            showStatus('正在发送到打印机...', true);
            
            // 使用Android接口发送ZPL代码
            if (window.PrinterInterface) {
                window.PrinterInterface.sendToPrinter(ip, port, zplCode);
            } else {
                showStatus('打印机接口不可用', false);
            }
        }
        
        // 打印机发送结果回调
        function onPrinterSendResult(success, message) {
            if (success) {
                showStatus('打印命令发送成功！', true);
            } else {
                showStatus('发送打印命令失败: ' + message, false);
            }
        }
        
        // 测试函数
        function testFunction() {
            alert('JavaScript is working!');
        }
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', async function() {
            showStatus('设置页面已启动', true);
            loadConfigs();
            updateSettingsStatus();
            
            // 从 localStorage 加载已选择的标签组
            const savedLabelGroup = localStorage.getItem('selectedLabelGroup');
            if (savedLabelGroup) {
                selectedLabelGroup = savedLabelGroup;
                // 恢复标签组选择框的值
                const labelGroupSelect = document.getElementById('labelGroupSelect');
                if (labelGroupSelect) {
                    // 需要先等待标签组列表加载完成
                    setTimeout(async () => {
                        if (selectedLabelGroup) {
                            labelGroupSelect.value = selectedLabelGroup;
                            // 如果有标签组数据缓存，显示标签组信息
                            if (labelGroupsCache[selectedLabelGroup]) {
                                showLabelGroupInfo();
                            } else {
                                // 重新加载标签组数据
                                await fetchLabelGroupLabels(selectedLabelGroup);
                                showLabelGroupInfo();
                            }
                        }
                    }, 1000);
                }
            }
            
            // 自动测试打印机连接
            const printerConfig = localStorage.getItem('printerConfig');
            if (printerConfig) {
                const config = JSON.parse(printerConfig);
                if (config.ip && config.port) {
                    // 直接使用配置中的IP和端口测试连接
                    testPrinterWithConfig(config.ip, config.port);
                    // 更新设置页面状态
                    updateSettingsStatus();
                }
            }
            
            // 加载标签组
            fetchLabelGroups();
            
            // 加载打印模板
            loadTemplate();
            
            // 定时同步待更新数据（每30秒）
            setInterval(syncPendingUpdates, 30000);
        });
    </script>
</body>
</html>