<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZAP æ ‡ç­¾æ‰“å°</title>
    <style>
        body {
            margin: 0;
            padding: 5px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #007bff;
            color: white;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .settings-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .page {
            display: none;
            padding: 8px;
        }
        
        .page.active {
            display: block;
        }
        
        .scan-section {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .scan-section h3 {
            margin-top: 0;
            color: #666;
        }
        
        .scan-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .scan-input-container input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ccc;
            border-radius: 5px;
            font-size: 18px;
            font-family: monospace;
            text-align: center;
            box-sizing: border-box;
        }
        
        .scan-input-container input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .scan-input-container button {
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .scan-input-container button:hover {
            background: #0056b3;
        }
        
        .error-section {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 3px;
            border: 1px solid #f5c6cb;
            font-size: 14px;
        }
        
        .error-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .error-icon {
            font-size: 1.2rem;
        }
        
        .error-close {
            background: none;
            border: none;
            color: #721c24;
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: auto;
        }
        
        .query-result-section {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #28a745;
            border-radius: 5px;
            background: #d4edda;
        }
        
        .query-result-section h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #155724;
            font-size: 1rem;
        }
        
        .query-result-content {
            font-size: 14px;
            color: #155724;
        }
        
        .query-result-item {
            margin: 5px 0;
            padding: 5px;
            background: rgba(255,255,255,0.5);
            border-radius: 3px;
        }
        
        .query-result-label {
            font-weight: bold;
            display: inline-block;
            min-width: 80px;
        }
        
        
        .status-indicators {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .status-icon {
            font-size: 1rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background: #28a745;
        }
        
        .status-dot.offline {
            background: #dc3545;
        }
        
        .settings-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #ddd;
        }
        
        .settings-header h2 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .tab-nav {
            display: flex;
            margin-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-btn {
            flex: 1;
            padding: 8px;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            color: #666;
        }
        
        .tab-btn.active {
            background: white;
            color: #007bff;
            border-bottom-color: #007bff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .settings-section {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-header h3 {
            margin: 0;
            color: #666;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 8px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .form-actions button {
            flex: 1;
            min-width: 100px;
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .form-actions button:hover {
            background: #0056b3;
        }
        
        .label-group-info {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .group-name, .group-description, .group-stats {
            margin: 3px 0;
        }
        
        .label-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .label-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-family: monospace;
        }
        
        .label-item:last-child {
            border-bottom: none;
        }
        
        .label-barcode {
            font-weight: bold;
            color: #333;
        }
        
        .label-count {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .label-count.available {
            background: #d4edda;
            color: #155724;
        }
        
        .label-count.unlimited {
            background: #cce5ff;
            color: #004085;
        }
        
        .label-count.empty {
            background: #f8d7da;
            color: #721c24;
        }
        
        .label-empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .label {
            font-weight: bold;
            min-width: 80px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-dot.online {
            background: #28a745;
        }
        
        .status-dot.offline {
            background: #dc3545;
        }
        
        .cache-status {
            margin: 12px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        
        .cache-info {
            font-size: 0.9rem;
            color: #666;
        }
        
        .cache-info div {
            margin: 5px 0;
        }
        
        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .form-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>EZAP æ ‡ç­¾æ‰“å°</h1>
            <button class="settings-btn" onclick="showSettings()" title="è®¾ç½®">âš™ï¸</button>
        </div>
        
        <!-- ä¸šåŠ¡é¡µé¢ -->
        <div id="businessPage" class="page active">
            <!-- æ‰«ç è¾“å…¥åŒºåŸŸ -->
            <div class="scan-section">
                <h3>æ‰«ç æ‰“å°</h3>
                <div class="scan-input-container">
                    <input type="text" id="barcodeInput" placeholder="æ‰«ææˆ–è¾“å…¥æ¡ç " oninput="onBarcodeInput()" onkeypress="onBarcodeKeyPress(event)">
                    <button onclick="printBarcode()">æ‰“å°</button>
                </div>
            </div>
            
            <!-- å¼‚å¸¸æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="errorSection" class="error-section" style="display: none;">
                <div class="error-content">
                    <span class="error-icon">âš ï¸</span>
                    <span id="errorMessage">é”™è¯¯ä¿¡æ¯</span>
                    <button class="error-close" onclick="hideError()">Ã—</button>
                </div>
            </div>
            
            <!-- æŸ¥è¯¢ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="queryResultSection" class="query-result-section" style="display: none;">
                <h3>æŸ¥è¯¢ç»“æœ</h3>
                <div id="queryResultContent" class="query-result-content">
                    <!-- æŸ¥è¯¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <!-- å·¦ä¸‹è§’çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="status-indicators">
                <div class="status-indicator" title="æ‰“å°æœºçŠ¶æ€">
                    <span class="status-icon">ğŸ–¨ï¸</span>
                    <span id="printerStatus" class="status-dot offline"></span>
                </div>
            </div>
        </div>
        
        <!-- è®¾ç½®é¡µé¢ -->
        <div id="settingsPage" class="page">
            <div class="settings-header">
                <button class="back-btn" onclick="showBusiness()">â† è¿”å›</button>
                <h2>è®¾ç½®</h2>
            </div>
            
            <!-- Tabå¯¼èˆª -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('printer')">æ‰“å°æœº</button>
                <button class="tab-btn" onclick="switchTab('label')">æ ‡ç­¾</button>
                <button class="tab-btn" onclick="switchTab('template')">æ¨¡æ¿</button>
            </div>
            
            
            <!-- æ‰“å°æœºè®¾ç½®Tab -->
            <div id="printerTab" class="tab-content active">
                <div class="settings-section">
                    <div class="section-header">
                        <h3>æ‰“å°æœºè®¾ç½®</h3>
                        <div class="status-indicator">
                            <div id="printerStatusIndicator" class="status-dot offline"></div>
                            <span id="printerStatusText">æœªè¿æ¥</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ‰“å°æœºIPåœ°å€:</label>
                        <input type="text" id="printerIp" placeholder="192.168.1.100" value="192.168.1.100">
                    </div>
                    <div class="form-group">
                        <label>ç«¯å£å·:</label>
                        <input type="number" id="printerPort" placeholder="9100" value="9100">
                    </div>
                    <div class="form-actions">
                        <button onclick="testPrinter()" id="testPrinterBtn">æµ‹è¯•è¿æ¥</button>
                        <button onclick="savePrinterConfig()" id="savePrinterBtn">ä¿å­˜é…ç½®</button>
                        <button onclick="printTestPage()" id="printTestBtn" disabled>æµ‹è¯•æ‰“å°</button>
                    </div>
                </div>
            </div>
            
            <!-- æ ‡ç­¾è®¾ç½®Tab -->
            <div id="labelTab" class="tab-content">
                <div class="settings-section">
                    <div class="section-header">
                        <h3>æ ‡ç­¾ç»„è®¾ç½®</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>é€‰æ‹©æ ‡ç­¾ç»„:</label>
                        <select id="labelGroupSelect" onchange="onLabelGroupChange()">
                            <option value="">è¯·é€‰æ‹©æ ‡ç­¾ç»„</option>
                        </select>
                    </div>
                    
                    <div id="labelGroupInfo" class="label-group-info" style="display: none;">
                        <div class="group-name">å½“å‰é€‰æ‹©: <span id="currentGroupName">-</span></div>
                        <div class="group-description">æè¿°: <span id="groupDescription">-</span></div>
                        <div class="group-stats">æ ‡ç­¾æ•°é‡: <span id="labelCount">0</span> | å¾…åŒæ­¥: <span id="pendingSync">0</span>æ¡</div>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="refreshLabelGroups()" id="refreshBtn">åˆ·æ–°æ ‡ç­¾ç»„</button>
                        <button onclick="syncToServer()" id="syncBtn" disabled>åŒæ­¥æœåŠ¡å™¨</button>
                    </div>
                </div>
                
                <!-- ç¼“å­˜ç®¡ç†åŒºåŸŸ -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3>ç¼“å­˜ç®¡ç†</h3>
                        <div class="status-indicator">
                            <div id="cacheStatusIndicator" class="status-dot offline"></div>
                            <span id="cacheStatusText">æœªç¼“å­˜</span>
                        </div>
                    </div>
                    
                    
                    
                    <div class="cache-status">
                        <div class="cache-info">
                            <div>æ ‡ç­¾æ•°æ®ç¼“å­˜: <span id="labelDataCacheStatus">æœªç¼“å­˜</span></div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="refreshCache('labelData')" id="refreshLabelDataBtn">åˆ·æ–°æ ‡ç­¾æ•°æ®ç¼“å­˜</button>
                        <button onclick="clearCache('all')" id="clearCacheBtn">æ¸…é™¤æ‰€æœ‰ç¼“å­˜</button>
                    </div>
                </div>
                
            </div>
            
            <!-- æ¨¡æ¿è®¾ç½®Tab -->
            <div id="templateTab" class="tab-content">
                <div class="settings-section">
                    <div class="section-header">
                        <h3>æ‰“å°æ¨¡æ¿è®¾ç½®</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>æ¨¡æ¿åç§°:</label>
                        <input type="text" id="templateName" placeholder="ZP621æ ‡å‡†æ¨¡æ¿" value="ZP621æ ‡å‡†æ¨¡æ¿">
                    </div>
                    
                    <div class="form-group">
                        <label>æ¨¡æ¿å†…å®¹ (ZPLä»£ç ):</label>
                        <textarea id="templateContent" rows="15" style="width: 100%; font-family: monospace; font-size: 12px; padding: 8px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box;">^XA
^PW400
^LL300
^CF0,20

; === æ¡ç åŒºåŸŸï¼ˆå±…ä¸­ï¼‰ ===
^FO40,20
^BY2,2,100
^BCN,100,Y,N,N
^FD{{barcode}}^FS

; === äº§å“æè¿°ï¼ˆå·¦å¯¹é½ï¼Œè‡ªåŠ¨æ¢è¡Œå¤šè¡Œï¼‰ ===
^CFA,20
^FO60,200
^FB320,4,0,L,0
^FD{{product_description}}^FS

; === å›ºå®šçŠ¶æ€è¡Œï¼ˆå·¦å¯¹é½ï¼‰ ===
^CF0,22
^FO60,280^FDNew^FS

^XZ</textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button onclick="saveTemplate()" id="saveTemplateBtn">ä¿å­˜æ¨¡æ¿</button>
                        <button onclick="loadTemplate()" id="loadTemplateBtn">åŠ è½½æ¨¡æ¿</button>
                        <button onclick="testTemplate()" id="testTemplateBtn">æµ‹è¯•æ¨¡æ¿</button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="section-header">
                        <h3>æ¨¡æ¿å˜é‡è¯´æ˜</h3>
                    </div>
                    <div style="font-size: 14px; color: #666; line-height: 1.5;">
                        <p><strong>å¯ç”¨å˜é‡:</strong></p>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li><code>{{barcode}}</code> - æ–°æ¡ç </li>
                            <li><code>{{product_description}}</code> - äº§å“æè¿°</li>
                            <li><code>{{product_name}}</code> - äº§å“åç§°</li>
                        </ul>
                        <p><strong>æ¨¡æ¿è¯´æ˜:</strong></p>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>æ ‡ç­¾å°ºå¯¸: 600x450 ç‚¹</li>
                            <li>æ¡ç ç±»å‹: Code128</li>
                            <li>äº§å“æè¿°æ”¯æŒè‡ªåŠ¨æ¢è¡Œï¼ˆæœ€å¤š2è¡Œï¼‰</li>
                            <li>çŠ¶æ€å›ºå®šæ˜¾ç¤ºä¸º"New"</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let printerConnected = false;
        
        // æ ‡ç­¾ç»„ç›¸å…³å˜é‡
        let labelGroups = [];
        let selectedLabelGroup = null;
        let labelGroupsCache = {};
        let pendingUpdates = [];
        
        // æ¨¡æ¿ç›¸å…³å˜é‡
        let currentTemplate = null;
        
        function showStatus(message, isSuccess) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isSuccess ? 'success' : 'error');
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }
        
        function updateStatusDisplay() {
            const printerStatus = document.getElementById('printerStatus');
            
            // æ›´æ–°æ‰“å°æœºçŠ¶æ€
            if (printerConnected) {
                printerStatus.className = 'status-dot online';
            } else {
                printerStatus.className = 'status-dot offline';
            }
        }
        
        function onBarcodeInput() {
            // æ­£å¸¸è¾“å…¥æ—¶ä¸é€‰ä¸­å†…å®¹ï¼Œä¿æŒæ­£å¸¸è¾“å…¥ä½“éªŒ
        }
        
        function onBarcodeKeyPress(event) {
            // å›è½¦é”®ç›´æ¥æ‰“å°
            if (event.key === 'Enter') {
                event.preventDefault();
                // å›è½¦æ—¶é€‰ä¸­æ‰€æœ‰å†…å®¹ï¼Œæ–¹ä¾¿æ‰«ç æªä½¿ç”¨
                const input = document.getElementById('barcodeInput');
                input.select();
                printBarcode();
            }
        }
        
        function testPrinter() {
            const ip = document.getElementById('printerIp').value;
            const port = document.getElementById('printerPort').value;
            
            if (!ip || !port) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„æ‰“å°æœºä¿¡æ¯', false);
                return;
            }
            
            showStatus('æ­£åœ¨æµ‹è¯•è¿æ¥...', true);
            console.log('æµ‹è¯•è¿æ¥ - IP:', ip, 'Port:', port);
            console.log('PrinterInterface å¯ç”¨:', !!window.PrinterInterface);
            
            // ä½¿ç”¨Androidæ¥å£æµ‹è¯•è¿æ¥
            if (window.PrinterInterface) {
                console.log('è°ƒç”¨ Android æ¥å£æµ‹è¯•è¿æ¥');
                window.PrinterInterface.testPrinterConnection(ip, port);
            } else {
                console.log('PrinterInterface ä¸å¯ç”¨');
                showStatus('æ‰“å°æœºæ¥å£ä¸å¯ç”¨', false);
            }
        }
        
        // æ‰“å°æœºæµ‹è¯•ç»“æœå›è°ƒ
        function onPrinterTestResult(success, message) {
            if (success) {
                printerConnected = true;
                updateStatusDisplay();
                showStatus('æ‰“å°æœºè¿æ¥æˆåŠŸï¼', true);
            } else {
                printerConnected = false;
                updateStatusDisplay();
                showStatus('æ‰“å°æœºè¿æ¥å¤±è´¥ï¼š' + message, false);
            }
        }
        
        function printBarcode() {
            const barcode = document.getElementById('barcodeInput').value.trim();
            console.log('ğŸ” å¼€å§‹æ‰«ç æ‰“å°æµç¨‹ï¼Œè¾“å…¥æ¡ç :', barcode);
            
            if (!barcode) {
                console.log('âŒ æ¡ç ä¸ºç©º');
                showError('è¯·è¾“å…¥æ¡ç ');
                hideQueryResult();
                return;
            }
            
            // å…ˆæ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
            showQueryResult(barcode);
            
            if (!printerConnected) {
                console.log('âŒ æ‰“å°æœºæœªè¿æ¥');
                showError('æ‰“å°æœºæœªè¿æ¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®');
                return;
            }
            
            if (!selectedLabelGroup) {
                console.log('âŒ æœªé€‰æ‹©æ ‡ç­¾ç»„');
                showError('è¯·å…ˆé€‰æ‹©æ ‡ç­¾ç»„');
                return;
            }
            
            console.log('ğŸ” æŸ¥æ‰¾æ ‡ç­¾é…ç½®ï¼Œæ ‡ç­¾ç»„:', selectedLabelGroup);
            // æŸ¥æ‰¾æ ‡ç­¾é…ç½®
            const label = findLabelByBarcode(barcode);
            if (!label) {
                console.log('âŒ æœªæ‰¾åˆ°å¯¹åº”çš„æ ‡ç­¾é…ç½®');
                showError('æœªæ‰¾åˆ°å¯¹åº”çš„æ ‡ç­¾é…ç½®');
                return;
            }
            
            console.log('âœ… æ‰¾åˆ°æ ‡ç­¾é…ç½®:', label);
            // æ£€æŸ¥countçŠ¶æ€
            if (label.count === 0) {
                console.log('âŒ æ ‡ç­¾æ•°é‡ä¸º0');
                showError('å½“å‰æ¡ç æ²¡æœ‰å¯¹åº”çš„æ–°æ¡ç ');
                return;
            }
            
            showStatus('æ­£åœ¨æ‰“å°...', true);
            hideError(); // éšè—ä¹‹å‰çš„é”™è¯¯
            
            // ä½¿ç”¨æ¨¡æ¿è¿›è¡Œå®é™…æ‰“å°
            if (currentTemplate) {
                const printData = {
                    barcode: label.newBarcode,
                    product_description: label.description,
                    product_name: label.productName
                };
                
                const zplCode = generateZPL(currentTemplate.content, printData);
                console.log('ç”Ÿæˆçš„ZPLä»£ç :', zplCode);
                
                // å‘é€åˆ°æ‰“å°æœº
                sendToPrinter(zplCode);
                
                // æ›´æ–°countï¼ˆ-1è¡¨ç¤ºæ— é™æ‰“å°ï¼Œä¸éœ€è¦å‡1ï¼‰
                if (label.count > 0) {
                    updateLabelCount(barcode, label.count - 1);
                }
                
                showStatus(`æ‰“å°å‘½ä»¤å·²å‘é€ï¼${label.productName} - ${label.newBarcode}`, true);
            } else {
                // å¦‚æœæ²¡æœ‰æ¨¡æ¿ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ‰“å°
                setTimeout(() => {
                    const success = Math.random() > 0.1;
                    
                    if (success) {
                        if (label.count > 0) {
                            updateLabelCount(barcode, label.count - 1);
                        }
                        showStatus(`æ‰“å°æˆåŠŸï¼${label.productName} - ${label.newBarcode}`, true);
                    } else {
                        showError('æ‰“å°å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }, 2000);
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡æ–°é€‰ä¸­
            document.getElementById('barcodeInput').value = '';
            document.getElementById('barcodeInput').focus();
        }
        
        function generateNewBarcode(oldBarcode) {
            // æ¨¡æ‹Ÿç”Ÿæˆæ–°æ¡ç çš„é€»è¾‘
            const timestamp = Date.now().toString().slice(-4);
            return oldBarcode + '-' + timestamp;
        }
        
        
        // checkServerStatuså‡½æ•°å·²ç§»é™¤ - ä¸å†éœ€è¦æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥
        
        // é¡µé¢åˆ‡æ¢åŠŸèƒ½
        function showSettings() {
            document.getElementById('businessPage').classList.remove('active');
            document.getElementById('settingsPage').classList.add('active');
        }
        
        function showBusiness() {
            document.getElementById('settingsPage').classList.remove('active');
            document.getElementById('businessPage').classList.add('active');
        }
        
        // é”™è¯¯æ˜¾ç¤ºåŠŸèƒ½
        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorSection.style.display = 'block';
        }
        
        function hideError() {
            const errorSection = document.getElementById('errorSection');
            errorSection.style.display = 'none';
        }
        
        function showQueryResult(barcode) {
            const queryResultSection = document.getElementById('queryResultSection');
            const queryResultContent = document.getElementById('queryResultContent');
            
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            queryResultContent.innerHTML = '';
            
            // æ˜¾ç¤ºè¾“å…¥æ¡ç 
            queryResultContent.innerHTML += `
                <div class="query-result-item">
                    <span class="query-result-label">è¾“å…¥æ¡ç :</span>
                    <span>${barcode}</span>
                </div>
            `;
            
            // æ˜¾ç¤ºæ ‡ç­¾ç»„ä¿¡æ¯
            if (selectedLabelGroup) {
                const group = labelGroups.find(g => g.id === selectedLabelGroup);
                queryResultContent.innerHTML += `
                    <div class="query-result-item">
                        <span class="query-result-label">æ ‡ç­¾ç»„:</span>
                        <span>${group ? group.name : selectedLabelGroup}</span>
                    </div>
                `;
            } else {
                queryResultContent.innerHTML += `
                    <div class="query-result-item">
                        <span class="query-result-label">æ ‡ç­¾ç»„:</span>
                        <span style="color: #dc3545;">æœªé€‰æ‹©</span>
                    </div>
                `;
            }
            
            // æŸ¥æ‰¾æ ‡ç­¾é…ç½®
            if (selectedLabelGroup) {
                const label = findLabelByBarcode(barcode);
                if (label) {
                    queryResultContent.innerHTML += `
                        <div class="query-result-item">
                            <span class="query-result-label">æ–°æ¡ç :</span>
                            <span>${label.newBarcode}</span>
                        </div>
                        <div class="query-result-item">
                            <span class="query-result-label">äº§å“åç§°:</span>
                            <span>${label.productName}</span>
                        </div>
                        <div class="query-result-item">
                            <span class="query-result-label">äº§å“æè¿°:</span>
                            <span>${label.description}</span>
                        </div>
                        <div class="query-result-item">
                            <span class="query-result-label">å‰©ä½™æ•°é‡:</span>
                            <span style="color: ${label.count > 0 ? '#28a745' : '#dc3545'};">${label.count === -1 ? 'æ— é™' : label.count}</span>
                        </div>
                    `;
                } else {
                    queryResultContent.innerHTML += `
                        <div class="query-result-item">
                            <span class="query-result-label">æŸ¥è¯¢ç»“æœ:</span>
                            <span style="color: #dc3545;">æœªæ‰¾åˆ°å¯¹åº”çš„æ ‡ç­¾é…ç½®</span>
                        </div>
                    `;
                }
            } else {
                queryResultContent.innerHTML += `
                    <div class="query-result-item">
                        <span class="query-result-label">æŸ¥è¯¢ç»“æœ:</span>
                        <span style="color: #dc3545;">è¯·å…ˆé€‰æ‹©æ ‡ç­¾ç»„</span>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœåŒºåŸŸ
            queryResultSection.style.display = 'block';
        }
        
        function hideQueryResult() {
            const queryResultSection = document.getElementById('queryResultSection');
            queryResultSection.style.display = 'none';
        }
        
        // Tabåˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰tabå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰tabæŒ‰é’®çš„activeçŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„tabå†…å®¹
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // æ¿€æ´»é€‰ä¸­çš„tabæŒ‰é’®
            event.target.classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°æ ‡ç­¾tabï¼Œæ›´æ–°ç¼“å­˜çŠ¶æ€
            if (tabName === 'label') {
                // æ¢å¤æ ‡ç­¾ç»„é€‰æ‹©æ¡†çš„å€¼
                const labelGroupSelect = document.getElementById('labelGroupSelect');
                if (selectedLabelGroup) {
                    labelGroupSelect.value = selectedLabelGroup;
                } else {
                    labelGroupSelect.value = '';
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜æ•°æ®ï¼Œå¦‚æœæœ‰åˆ™æ›´æ–°çŠ¶æ€
                let totalLabelCount = 0;
                Object.values(labelGroupsCache).forEach(group => {
                    if (group.labels) {
                        totalLabelCount += Object.keys(group.labels).length;
                    }
                });
                
                const labelDataStatus = document.getElementById('labelDataCacheStatus');
                const cacheIndicator = document.getElementById('cacheStatusIndicator');
                const cacheStatusText = document.getElementById('cacheStatusText');
                
                if (totalLabelCount > 0) {
                    labelDataStatus.textContent = `å·²ç¼“å­˜ (${totalLabelCount}æ¡æ ‡ç­¾)`;
                    cacheIndicator.className = 'status-dot online';
                    cacheStatusText.textContent = 'å·²ç¼“å­˜';
                } else {
                    labelDataStatus.textContent = 'æœªç¼“å­˜';
                    cacheIndicator.className = 'status-dot offline';
                    cacheStatusText.textContent = 'æœªç¼“å­˜';
                }
            }
        }
        
        // æ›´æ–°è®¾ç½®é¡µé¢çŠ¶æ€æ˜¾ç¤º
        function updateSettingsStatus() {
            
            // æ›´æ–°æ‰“å°æœºçŠ¶æ€
            const printerIndicator = document.getElementById('printerStatusIndicator');
            const printerText = document.getElementById('printerStatusText');
            const printTestBtn = document.getElementById('printTestBtn');
            if (printerConnected) {
                printerIndicator.className = 'status-dot online';
                printerText.textContent = 'å·²è¿æ¥';
                printTestBtn.disabled = false;
            } else {
                printerIndicator.className = 'status-dot offline';
                printerText.textContent = 'æœªè¿æ¥';
                printTestBtn.disabled = true;
            }
            
            // æ›´æ–°æ ‡ç­¾ç»„çŠ¶æ€
        }
        
        // è®¾ç½®é¡µé¢åŠŸèƒ½
        
        function savePrinterConfig() {
            const ip = document.getElementById('printerIp').value;
            const port = document.getElementById('printerPort').value;
            
            if (!ip || !port) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„æ‰“å°æœºä¿¡æ¯', false);
                return;
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('printerConfig', JSON.stringify({ip, port}));
            showStatus('æ‰“å°æœºé…ç½®ä¿å­˜æˆåŠŸï¼', true);
            updateSettingsStatus();
        }
        
        function saveLabelConfig() {
            const width = document.getElementById('labelWidth').value;
            const height = document.getElementById('labelHeight').value;
            const density = document.getElementById('printDensity').value;
            
            if (!width || !height) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„æ ‡ç­¾ä¿¡æ¯', false);
                return;
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('labelConfig', JSON.stringify({width, height, density}));
            showStatus('æ ‡ç­¾é…ç½®ä¿å­˜æˆåŠŸï¼', true);
            updateSettingsStatus();
        }
        
        function printTestPage() {
            if (!printerConnected) {
                showStatus('æ‰“å°æœºæœªè¿æ¥', false);
                return;
            }
            
            const printBtn = document.getElementById('printTestBtn');
            printBtn.disabled = true;
            printBtn.textContent = 'æ‰“å°ä¸­...';
            
            showStatus('æ­£åœ¨æ‰“å°æµ‹è¯•é¡µ...', true);
            
            // ç”Ÿæˆæµ‹è¯•é¡µ ZPL ä»£ç 
            const testZPL = `^XA
^FO50,50^ADN,36,20^FDæµ‹è¯•é¡µæ‰“å°^FS
^FO50,100^ADN,18,10^FDæ—¶é—´: ${new Date().toLocaleString()}^FS
^FO50,130^ADN,18,10^FDæ‰“å°æœºIP: ${document.getElementById('printerIp').value}^FS
^FO50,160^ADN,18,10^FDç«¯å£: ${document.getElementById('printerPort').value}^FS
^FO50,190^ADN,18,10^FDè¿æ¥çŠ¶æ€: æ­£å¸¸^FS
^FO50,220^ADN,18,10^FDæµ‹è¯•æ¡ç : 123456789^FS
^FO50,250^BY3
^BCN,100,Y,N,N
^FD123456789^FS
^XZ`;
            
            console.log('æµ‹è¯•é¡µ ZPL ä»£ç :', testZPL);
            
            // å‘é€åˆ°æ‰“å°æœº
            sendToPrinter(testZPL);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                printBtn.disabled = false;
                printBtn.textContent = 'æµ‹è¯•æ‰“å°';
            }, 3000);
        }
        
        // æ ‡ç­¾ç»„ç›¸å…³API
        async function fetchLabelGroups() {
            try {
                console.log('ğŸ”„ å¼€å§‹è·å–æ ‡ç­¾ç»„åˆ—è¡¨...');
                const response = await fetch('https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records?pageSize=100', {
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    }
                });
                console.log('ğŸ“¡ Vika APIå“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('ğŸ“Š è·å–åˆ°è®°å½•æ•°:', data.data?.records?.length || 0);
                
                if (data.success) {
                    // æŒ‰æ ‡ç­¾ç»„å­—æ®µåˆ†ç»„
                    const groupMap = new Map();
                    data.data.records.forEach(record => {
                        const groupName = record.fields['æ ‡ç­¾ç»„'];
                        if (groupName && !groupMap.has(groupName)) {
                            groupMap.set(groupName, {
                                id: groupName,
                                name: groupName,
                                description: `æ ‡ç­¾ç»„: ${groupName}`
                            });
                        }
                    });
                    
                    labelGroups = Array.from(groupMap.values());
                    updateLabelGroupSelect();
                    return true;
                } else {
                    throw new Error(data.message || 'è·å–æ ‡ç­¾ç»„å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–æ ‡ç­¾ç»„å¤±è´¥:', error);
                showStatus('è·å–æ ‡ç­¾ç»„å¤±è´¥: ' + error.message, false);
                return false;
            }
        }
        
        async function fetchLabelGroupLabels(groupId) {
            try {
                const response = await fetch('https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records?pageSize=100', {
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    // ç­›é€‰æŒ‡å®šæ ‡ç­¾ç»„çš„è®°å½•
                    const groupRecords = data.data.records.filter(record => {
                        return record.fields['æ ‡ç­¾ç»„'] === groupId;
                    });
                    
                    // ä¿å­˜åˆ°ç¼“å­˜
                    labelGroupsCache[groupId] = {
                        name: labelGroups.find(g => g.id === groupId)?.name || '',
                        description: labelGroups.find(g => g.id === groupId)?.description || '',
                        labels: {}
                    };
                    
                    // å¤„ç†æ ‡ç­¾æ•°æ®
                    groupRecords.forEach(record => {
                        const oldBarcode = record.fields['æ—§æ ‡ç­¾'];
                        const newBarcode = record.fields['æ–°æ ‡ç­¾'];
                        if (oldBarcode && newBarcode) {
                            labelGroupsCache[groupId].labels[oldBarcode] = {
                                newBarcode: newBarcode,
                                productName: record.fields['äº§å“åç§°'] || 'äº§å“',
                                description: record.fields['äº§å“æè¿°'] || 'äº§å“æè¿°',
                                count: record.fields['æ¢æ ‡æ•°é‡'] || 1,
                                originalCount: record.fields['æ¢æ ‡æ•°é‡'] || 1
                            };
                        }
                    });
                    
                    return true;
                } else {
                    showStatus('è·å–æ ‡ç­¾æ•°æ®å¤±è´¥: ' + data.message, false);
                    return false;
                }
            } catch (error) {
                console.error('è·å–æ ‡ç­¾æ•°æ®å¤±è´¥:', error);
                showStatus('è·å–æ ‡ç­¾æ•°æ®å¤±è´¥: ' + error.message, false);
                return false;
            }
        }
        
        async function syncPendingUpdates() {
            if (pendingUpdates.length === 0) return;
            
            try {
                // ç›´æ¥è°ƒç”¨Vika APIæ›´æ–°è®°å½•
                for (const update of pendingUpdates) {
                    await updateVikaRecord(update);
                }
                
                pendingUpdates = [];
                updatePendingSyncCount();
                showStatus('æ•°æ®åŒæ­¥æˆåŠŸï¼', true);
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                showStatus('åŒæ­¥å¤±è´¥: ' + error.message, false);
            }
        }
        
        // ç›´æ¥è°ƒç”¨Vika APIæ›´æ–°è®°å½•
        async function updateVikaRecord(update) {
            try {
                // å…ˆè·å–è®°å½•ID
                const recordId = await findRecordIdByOldBarcode(update.oldBarcode, update.groupId);
                if (!recordId) {
                    throw new Error(`æœªæ‰¾åˆ°è®°å½•: ${update.oldBarcode}`);
                }
                
                // æ›´æ–°è®°å½•
                const response = await fetch(`https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records/${recordId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            'æ¢æ ‡æ•°é‡': update.count
                        }
                    })
                });
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'æ›´æ–°è®°å½•å¤±è´¥');
                }
                
                return true;
            } catch (error) {
                console.error('æ›´æ–°Vikaè®°å½•å¤±è´¥:', error);
                throw error;
            }
        }
        
        // æ ¹æ®æ—§æ¡ç å’Œæ ‡ç­¾ç»„æŸ¥æ‰¾è®°å½•ID
        async function findRecordIdByOldBarcode(oldBarcode, groupId) {
            try {
                const response = await fetch('https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records?pageSize=100', {
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const record = data.data.records.find(record => 
                        record.fields['æ—§æ ‡ç­¾'] === oldBarcode && 
                        record.fields['æ ‡ç­¾ç»„'] === groupId
                    );
                    return record ? record.recordId : null;
                }
                return null;
            } catch (error) {
                console.error('æŸ¥æ‰¾è®°å½•IDå¤±è´¥:', error);
                return null;
            }
        }
        
        // æ ‡ç­¾ç»„é€‰æ‹©ç›¸å…³
        function updateLabelGroupSelect() {
            const select = document.getElementById('labelGroupSelect');
            const currentValue = select.value; // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æ ‡ç­¾ç»„</option>';
            
            labelGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                select.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼
            if (currentValue && selectedLabelGroup === currentValue) {
                select.value = currentValue;
            }
        }
        
        async function onLabelGroupChange() {
            const groupId = document.getElementById('labelGroupSelect').value;
            
            if (!groupId) {
                selectedLabelGroup = null;
                hideLabelGroupInfo();
                return;
            }
            
            // åŠ è½½æ ‡ç­¾ç»„æ•°æ®
            const success = await fetchLabelGroupLabels(groupId);
            if (success) {
                selectedLabelGroup = groupId;
                showLabelGroupInfo();
                updateSettingsStatus();
            }
        }
        
        function showLabelGroupInfo() {
            const group = labelGroups.find(g => g.id === selectedLabelGroup);
            const cache = labelGroupsCache[selectedLabelGroup];
            
            if (group && cache) {
                document.getElementById('currentGroupName').textContent = group.name;
                document.getElementById('groupDescription').textContent = group.description;
                document.getElementById('labelCount').textContent = Object.keys(cache.labels).length;
                document.getElementById('pendingSync').textContent = pendingUpdates.length;
                
                document.getElementById('labelGroupInfo').style.display = 'block';
            }
        }
        
        function hideLabelGroupInfo() {
            document.getElementById('labelGroupInfo').style.display = 'none';
        }
        
        
        function updatePendingSyncCount() {
            document.getElementById('pendingSync').textContent = pendingUpdates.length;
            const syncBtn = document.getElementById('syncBtn');
            syncBtn.disabled = pendingUpdates.length === 0;
        }
        
        async function refreshLabelGroups() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
            
            const success = await fetchLabelGroups();
            
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'åˆ·æ–°æ ‡ç­¾ç»„';
            
            if (success) {
                showStatus('æ ‡ç­¾ç»„åˆ·æ–°æˆåŠŸï¼', true);
            }
        }
        
        async function syncToServer() {
            if (pendingUpdates.length === 0) {
                showStatus('æ²¡æœ‰æ•°æ®éœ€è¦åŒæ­¥', true);
                return;
            }
            
            const syncBtn = document.getElementById('syncBtn');
            syncBtn.disabled = true;
            syncBtn.textContent = 'åŒæ­¥ä¸­...';
            
            showStatus('æ­£åœ¨åŒæ­¥åˆ°åœ¨çº¿è¡¨æ ¼...', true);
            
            await syncPendingUpdates();
            
            syncBtn.disabled = false;
            syncBtn.textContent = 'åŒæ­¥æœåŠ¡å™¨';
        }
        
        // æ‰«ç æ‰“å°ä¸šåŠ¡é€»è¾‘
        function findLabelByBarcode(oldBarcode) {
            if (!selectedLabelGroup || !labelGroupsCache[selectedLabelGroup]) {
                return null;
            }
            
            const cache = labelGroupsCache[selectedLabelGroup];
            // å¤§å°å†™ä¸æ•æ„ŸæŸ¥æ‰¾
            for (const [key, value] of Object.entries(cache.labels)) {
                if (key.toLowerCase() === oldBarcode.toLowerCase()) {
                    return value;
                }
            }
            return null;
        }
        
        function updateLabelCount(oldBarcode, newCount) {
            if (!selectedLabelGroup || !labelGroupsCache[selectedLabelGroup]) {
                return;
            }
            
            const cache = labelGroupsCache[selectedLabelGroup];
            if (cache.labels[oldBarcode]) {
                cache.labels[oldBarcode].count = newCount;
                
                // å¦‚æœcountå˜ä¸º0ï¼ŒåŠ å…¥å¾…åŒæ­¥é˜Ÿåˆ—
                if (newCount === 0 && cache.labels[oldBarcode].originalCount > 0) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å¾…åŒæ­¥é˜Ÿåˆ—ä¸­
                    const existingIndex = pendingUpdates.findIndex(update => 
                        update.oldBarcode === oldBarcode
                    );
                    
                    if (existingIndex === -1) {
                        pendingUpdates.push({
                            groupId: selectedLabelGroup,
                            oldBarcode: oldBarcode,
                            count: 0
                        });
                    }
                    
                    updatePendingSyncCount();
                }
                
            }
        }
        
        function loadConfigs() {
            // åŠ è½½æ‰“å°æœºé…ç½®
            const printerConfig = localStorage.getItem('printerConfig');
            if (printerConfig) {
                const config = JSON.parse(printerConfig);
                document.getElementById('printerIp').value = config.ip;
                document.getElementById('printerPort').value = config.port;
            }
            
            // åŠ è½½æ ‡ç­¾é…ç½®
            const labelConfig = localStorage.getItem('labelConfig');
            if (labelConfig) {
                const config = JSON.parse(labelConfig);
                document.getElementById('labelWidth').value = config.width;
                document.getElementById('labelHeight').value = config.height;
                document.getElementById('printDensity').value = config.density;
            }
        }
        
        // ç¼“å­˜ç®¡ç†å‡½æ•° - å·²ç§»é™¤serverä¾èµ–ï¼Œæ”¹ä¸ºçº¯å‰ç«¯ç¼“å­˜
        
        async function updateCacheStatus() {
            try {
                // è®¡ç®—æ‰€æœ‰æ ‡ç­¾ç»„ä¸­çš„æ ‡ç­¾æ•°æ®æ€»æ•°
                let totalLabelCount = 0;
                Object.values(labelGroupsCache).forEach(group => {
                    if (group.labels) {
                        totalLabelCount += Object.keys(group.labels).length;
                    }
                });
                
                // æ›´æ–°ç¼“å­˜çŠ¶æ€æŒ‡ç¤ºå™¨
                const cacheIndicator = document.getElementById('cacheStatusIndicator');
                const cacheStatusText = document.getElementById('cacheStatusText');
                
                if (totalLabelCount > 0) {
                    cacheIndicator.className = 'status-dot online';
                    cacheStatusText.textContent = 'å·²ç¼“å­˜';
                } else {
                    cacheIndicator.className = 'status-dot offline';
                    cacheStatusText.textContent = 'æœªç¼“å­˜';
                }
                
                // æ›´æ–°ç¼“å­˜ä¿¡æ¯
                const labelDataStatus = document.getElementById('labelDataCacheStatus');
                
                if (totalLabelCount > 0) {
                    labelDataStatus.textContent = `å·²ç¼“å­˜ (${totalLabelCount}æ¡æ ‡ç­¾)`;
                } else {
                    labelDataStatus.textContent = 'æœªç¼“å­˜';
                }
            } catch (error) {
                console.error('è·å–ç¼“å­˜çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        async function refreshCache(type) {
            try {
                showStatus('æ­£åœ¨åˆ·æ–°ç¼“å­˜...', true);
                
                if (type === 'labelData') {
                    // åˆ·æ–°æ ‡ç­¾æ•°æ®ç¼“å­˜ - é‡æ–°è·å–æ ‡ç­¾ç»„åˆ—è¡¨å’Œå½“å‰é€‰ä¸­ç»„çš„æ•°æ®
                    const success = await fetchLabelGroups();
                    if (success && selectedLabelGroup) {
                        // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„æ ‡ç­¾ç»„ï¼Œé‡æ–°è·å–å…¶æ•°æ®
                        const labelSuccess = await fetchLabelGroupLabels(selectedLabelGroup);
                        if (labelSuccess) {
                            showLabelGroupInfo();
                        }
                    }
                    if (success) {
                        showStatus('æ ‡ç­¾æ•°æ®ç¼“å­˜åˆ·æ–°å®Œæˆ', true);
                        updateCacheStatus();
                    } else {
                        showStatus('åˆ·æ–°æ ‡ç­¾æ•°æ®ç¼“å­˜å¤±è´¥', false);
                    }
                } else {
                    // å…¶ä»–ç±»å‹çš„ç¼“å­˜åˆ·æ–° - å·²ç§»é™¤serverä¾èµ–
                    showStatus('ç¼“å­˜åˆ·æ–°å®Œæˆ', true);
                    updateCacheStatus();
                }
            } catch (error) {
                showStatus('åˆ·æ–°ç¼“å­˜å¤±è´¥: ' + error.message, false);
            }
        }
        
        async function clearCache(type) {
            try {
                showStatus('æ­£åœ¨æ¸…é™¤ç¼“å­˜...', true);
                
                if (type === 'all') {
                    // æ¸…é™¤æœ¬åœ°æ ‡ç­¾æ•°æ®ç¼“å­˜ï¼Œä½†ä¿ç•™æ ‡ç­¾ç»„åˆ—è¡¨å’Œæ˜¾ç¤º
                    labelGroupsCache = {};
                    // ä¸æ¸…ç©º selectedLabelGroup å’Œ labelGroupsï¼Œä¸æ¸…ç©ºæ˜¾ç¤ºæ•°æ®
                    showStatus('ç¼“å­˜æ¸…é™¤æˆåŠŸï¼', true);
                    // ç«‹å³æ›´æ–°ç¼“å­˜çŠ¶æ€æ˜¾ç¤º
                    const labelDataStatus = document.getElementById('labelDataCacheStatus');
                    const cacheIndicator = document.getElementById('cacheStatusIndicator');
                    const cacheStatusText = document.getElementById('cacheStatusText');
                    
                    labelDataStatus.textContent = 'æœªç¼“å­˜';
                    cacheIndicator.className = 'status-dot offline';
                    cacheStatusText.textContent = 'æœªç¼“å­˜';
                } else {
                    // å…¶ä»–ç±»å‹çš„ç¼“å­˜æ¸…é™¤ - å·²ç§»é™¤serverä¾èµ–
                    showStatus('ç¼“å­˜å·²æ¸…é™¤', true);
                    updateCacheStatus();
                }
            } catch (error) {
                showStatus('æ¸…é™¤ç¼“å­˜å¤±è´¥: ' + error.message, false);
            }
        }
        
        // æ¨¡æ¿ç®¡ç†å‡½æ•°
        function saveTemplate() {
            const templateName = document.getElementById('templateName').value;
            const templateContent = document.getElementById('templateContent').value;
            
            if (!templateName || !templateContent) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„æ¨¡æ¿ä¿¡æ¯', false);
                return;
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const template = {
                name: templateName,
                content: templateContent,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('printTemplate', JSON.stringify(template));
            currentTemplate = template;
            showStatus('æ¨¡æ¿ä¿å­˜æˆåŠŸï¼', true);
        }
        
        function loadTemplate() {
            const savedTemplate = localStorage.getItem('printTemplate');
            if (savedTemplate) {
                const template = JSON.parse(savedTemplate);
                document.getElementById('templateName').value = template.name;
                document.getElementById('templateContent').value = template.content;
                currentTemplate = template;
                console.log('æ¨¡æ¿åŠ è½½æˆåŠŸï¼');
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ¨¡æ¿ï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿
                currentTemplate = {
                    name: 'ZP621æ ‡å‡†æ¨¡æ¿',
                    content: document.getElementById('templateContent').value
                };
                console.log('ä½¿ç”¨é»˜è®¤æ¨¡æ¿');
            }
        }
        
        function testTemplate() {
            if (!currentTemplate) {
                showStatus('è¯·å…ˆä¿å­˜æ¨¡æ¿', false);
                return;
            }
            
            // ä½¿ç”¨æµ‹è¯•æ•°æ®ç”ŸæˆZPLä»£ç 
            const testData = {
                barcode: 'TEST123456',
                product_description: 'æµ‹è¯•äº§å“æè¿° - è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„äº§å“æè¿°ç”¨æ¥æµ‹è¯•è‡ªåŠ¨æ¢è¡ŒåŠŸèƒ½',
                product_name: 'æµ‹è¯•äº§å“'
            };
            
            const zplCode = generateZPL(currentTemplate.content, testData);
            console.log('ç”Ÿæˆçš„ZPLä»£ç :', zplCode);
            
            // æ˜¾ç¤ºç”Ÿæˆçš„ZPLä»£ç 
            showStatus('æµ‹è¯•æ¨¡æ¿ç”ŸæˆæˆåŠŸï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—', true);
            
            // å¦‚æœæ‰“å°æœºå·²è¿æ¥ï¼Œå¯ä»¥å‘é€æµ‹è¯•æ‰“å°
            if (printerConnected) {
                sendToPrinter(zplCode);
            }
        }
        
        function generateZPL(template, data) {
            let zpl = template;
            
            // æ›¿æ¢å˜é‡
            zpl = zpl.replace(/\{\{barcode\}\}/g, data.barcode || '');
            zpl = zpl.replace(/\{\{product_description\}\}/g, data.product_description || '');
            zpl = zpl.replace(/\{\{product_name\}\}/g, data.product_name || '');
            
            return zpl;
        }
        
        function sendToPrinter(zplCode) {
            const ip = document.getElementById('printerIp').value;
            const port = document.getElementById('printerPort').value;
            
            if (!ip || !port) {
                showStatus('è¯·å…ˆé…ç½®æ‰“å°æœºIPå’Œç«¯å£', false);
                return;
            }
            
            showStatus('æ­£åœ¨å‘é€åˆ°æ‰“å°æœº...', true);
            console.log('å‘é€æ‰“å° - IP:', ip, 'Port:', port);
            console.log('ZPLä»£ç :', zplCode);
            console.log('PrinterInterface å¯ç”¨:', !!window.PrinterInterface);
            
            // ä½¿ç”¨Androidæ¥å£å‘é€ZPLä»£ç 
            if (window.PrinterInterface) {
                console.log('è°ƒç”¨ Android æ¥å£å‘é€æ‰“å°');
                window.PrinterInterface.sendToPrinter(ip, port, zplCode);
            } else {
                console.log('PrinterInterface ä¸å¯ç”¨');
                showStatus('æ‰“å°æœºæ¥å£ä¸å¯ç”¨', false);
            }
        }
        
        // æ‰“å°æœºå‘é€ç»“æœå›è°ƒ
        function onPrinterSendResult(success, message) {
            if (success) {
                showStatus('æ‰“å°å‘½ä»¤å‘é€æˆåŠŸï¼', true);
            } else {
                showStatus('å‘é€æ‰“å°å‘½ä»¤å¤±è´¥: ' + message, false);
            }
        }
        
        // æµ‹è¯•å‡½æ•°
        function testFunction() {
            alert('JavaScript is working!');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('åº”ç”¨å·²å¯åŠ¨', true);
            updateStatusDisplay();
            loadConfigs();
            updateSettingsStatus();
            
            // åŠ è½½æ ‡ç­¾ç»„
            fetchLabelGroups();
            
            // åŠ è½½æ‰“å°æ¨¡æ¿
            loadTemplate();
            
            // å®šæ—¶åŒæ­¥å¾…æ›´æ–°æ•°æ®ï¼ˆæ¯30ç§’ï¼‰
            setInterval(syncPendingUpdates, 30000);
        });
    </script>
</body>
</html>