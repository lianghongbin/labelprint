<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZAP æ ‡ç­¾æ‰“å°</title>
    <style>
        body {
            margin: 0;
            padding: 5px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #007bff;
            color: white;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .settings-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .page {
            padding: 8px;
        }
        
        .scan-section {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .scan-section h3 {
            margin-top: 0;
            color: #666;
        }
        
        .scan-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .scan-input-container input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ccc;
            border-radius: 5px;
            font-size: 18px;
            font-family: monospace;
            text-align: center;
            box-sizing: border-box;
        }
        
        .scan-input-container input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .scan-input-container button {
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .scan-input-container button:hover {
            background: #0056b3;
        }
        
        .error-section {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 3px;
            border: 1px solid #f5c6cb;
            font-size: 14px;
        }
        
        .error-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .error-icon {
            font-size: 1.2rem;
        }
        
        .error-close {
            background: none;
            border: none;
            color: #721c24;
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: auto;
        }
        
        .query-result-section {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #28a745;
            border-radius: 5px;
            background: #d4edda;
        }
        
        .query-result-section h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #155724;
            font-size: 1rem;
        }
        
        .query-result-content {
            font-size: 14px;
            color: #155724;
        }
        
        .query-result-item {
            margin: 5px 0;
            padding: 5px;
            background: rgba(255,255,255,0.5);
            border-radius: 3px;
        }
        
        .query-result-label {
            font-weight: bold;
            display: inline-block;
            min-width: 80px;
        }
        
        .status-indicators {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .status-icon {
            font-size: 1rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background: #28a745;
        }
        
        .status-dot.offline {
            background: #dc3545;
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>EZAP æ ‡ç­¾æ‰“å°</h1>
            <button class="settings-btn" id="topRightBtn" onclick="openSettings()" title="è®¾ç½®">âš™ï¸</button>
        </div>
        
        <!-- æ‰“å°ä¸šåŠ¡é¡µé¢ -->
        <div class="page">
            <!-- æ‰«ç è¾“å…¥åŒºåŸŸ -->
            <div class="scan-section">
                <h3>æ‰«ç æ‰“å°</h3>
                <div class="scan-input-container">
                    <input type="text" id="barcodeInput" placeholder="æ‰«ææˆ–è¾“å…¥æ¡ç " oninput="onBarcodeInput()" onkeypress="onBarcodeKeyPress(event)">
                    <button onclick="printBarcode()">æ‰“å°</button>
                </div>
            </div>
            
            <!-- å¼‚å¸¸æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="errorSection" class="error-section" style="display: none;">
                <div class="error-content">
                    <span class="error-icon">âš ï¸</span>
                    <span id="errorMessage">é”™è¯¯ä¿¡æ¯</span>
                    <button class="error-close" onclick="hideError()">Ã—</button>
                </div>
            </div>
            
            <!-- æŸ¥è¯¢ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="queryResultSection" class="query-result-section" style="display: none;">
                <h3>æŸ¥è¯¢ç»“æœ</h3>
                <div id="queryResultContent" class="query-result-content">
                    <!-- æŸ¥è¯¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <!-- å·¦ä¸‹è§’çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="status-indicators">
                <div class="status-indicator" title="æ‰“å°æœºçŠ¶æ€">
                    <span class="status-icon">ğŸ–¨ï¸</span>
                    <span id="printerStatus" class="status-dot offline"></span>
                </div>
            </div>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let printerConnected = false;
        
        // æ ‡ç­¾ç»„ç›¸å…³å˜é‡
        let labelGroups = [];
        let selectedLabelGroup = null;
        let labelGroupsCache = {};
        let pendingUpdates = [];
        
        // æ¨¡æ¿ç›¸å…³å˜é‡
        let currentTemplate = null;
        
        function showStatus(message, isSuccess) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isSuccess ? 'success' : 'error');
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }
        
        function updateStatusDisplay() {
            const printerStatus = document.getElementById('printerStatus');
            
            // æ›´æ–°æ‰“å°æœºçŠ¶æ€
            if (printerConnected) {
                printerStatus.className = 'status-dot online';
            } else {
                printerStatus.className = 'status-dot offline';
            }
        }
        
        function onBarcodeInput() {
            // æ­£å¸¸è¾“å…¥æ—¶ä¸é€‰ä¸­å†…å®¹ï¼Œä¿æŒæ­£å¸¸è¾“å…¥ä½“éªŒ
        }
        
        function onBarcodeKeyPress(event) {
            // å›è½¦é”®ç›´æ¥æ‰“å°
            if (event.key === 'Enter') {
                event.preventDefault();
                // å›è½¦æ—¶é€‰ä¸­æ‰€æœ‰å†…å®¹ï¼Œæ–¹ä¾¿æ‰«ç æªä½¿ç”¨
                const input = document.getElementById('barcodeInput');
                input.select();
                printBarcode();
            }
        }
        
        // é”™è¯¯æ˜¾ç¤ºåŠŸèƒ½
        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorSection.style.display = 'block';
        }
        
        function hideError() {
            const errorSection = document.getElementById('errorSection');
            errorSection.style.display = 'none';
        }
        
        async function showQueryResult(barcode) {
            const queryResultSection = document.getElementById('queryResultSection');
            const queryResultContent = document.getElementById('queryResultContent');
            
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            queryResultContent.innerHTML = '';
            
            // æ˜¾ç¤ºè¾“å…¥æ¡ç 
            queryResultContent.innerHTML += `
                <div class="query-result-item">
                    <span class="query-result-label">è¾“å…¥æ¡ç :</span>
                    <span>${barcode}</span>
                </div>
            `;
            
            // æ˜¾ç¤ºæ ‡ç­¾ç»„ä¿¡æ¯
            if (selectedLabelGroup) {
                const group = labelGroups.find(g => g.id === selectedLabelGroup);
                queryResultContent.innerHTML += `
                    <div class="query-result-item">
                        <span class="query-result-label">æ ‡ç­¾ç»„:</span>
                        <span>${group ? group.name : selectedLabelGroup}</span>
                    </div>
                `;
            } else {
                queryResultContent.innerHTML += `
                    <div class="query-result-item">
                        <span class="query-result-label">æ ‡ç­¾ç»„:</span>
                        <span style="color: #dc3545;">æœªé€‰æ‹©</span>
                    </div>
                `;
            }
            
            // æŸ¥æ‰¾æ ‡ç­¾é…ç½®
            if (selectedLabelGroup) {
                const label = await findLabelByBarcode(barcode);
                if (label) {
                    queryResultContent.innerHTML += `
                        <div class="query-result-item">
                            <span class="query-result-label">æ–°æ¡ç :</span>
                            <span>${label.newBarcode}</span>
                        </div>
                        <div class="query-result-item">
                            <span class="query-result-label">äº§å“åç§°:</span>
                            <span>${label.productName}</span>
                        </div>
                        <div class="query-result-item">
                            <span class="query-result-label">å‰©ä½™æ•°é‡:</span>
                            <span style="color: ${label.count > 0 ? '#28a745' : '#dc3545'};">${label.count === -1 ? 'æ— é™' : label.count}</span>
                        </div>
                    `;
                } else {
                    queryResultContent.innerHTML += `
                        <div class="query-result-item">
                            <span class="query-result-label">æŸ¥è¯¢ç»“æœ:</span>
                            <span style="color: #dc3545;">æœªæ‰¾åˆ°å¯¹åº”çš„æ ‡ç­¾é…ç½®</span>
                        </div>
                    `;
                }
            } else {
                queryResultContent.innerHTML += `
                    <div class="query-result-item">
                        <span class="query-result-label">æŸ¥è¯¢ç»“æœ:</span>
                        <span style="color: #dc3545;">è¯·å…ˆé€‰æ‹©æ ‡ç­¾ç»„</span>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœåŒºåŸŸ
            queryResultSection.style.display = 'block';
        }
        
        function hideQueryResult() {
            const queryResultSection = document.getElementById('queryResultSection');
            queryResultSection.style.display = 'none';
        }
        
        function updatePendingSyncCount() {
            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) {
                syncBtn.disabled = pendingUpdates.length === 0;
            }
        }
        
        // ç›´æ¥è°ƒç”¨Vika APIæ›´æ–°è®°å½•
        async function updateVikaRecord(update) {
            try {
                console.log('ğŸ”„ å¼€å§‹æ›´æ–°Vikaè®°å½•:', JSON.stringify(update));
                // å…ˆè·å–è®°å½•ID
                const recordId = await findRecordIdByOldBarcode(update.oldBarcode, update.groupId);
                console.log('ğŸ“‹ æŸ¥æ‰¾åˆ°çš„è®°å½•ID:', recordId);
                if (!recordId) {
                    throw new Error(`æœªæ‰¾åˆ°è®°å½•: æ—§æ¡ç =${update.oldBarcode}, æ ‡ç­¾ç»„=${update.groupId}`);
                }
                
                // æ›´æ–°è®°å½• - ä½¿ç”¨ Vika API å•æ¡æ›´æ–°æ ¼å¼ï¼ˆæ‰¹é‡æ ¼å¼ï¼‰
                console.log('ğŸ”„ å‘é€PATCHè¯·æ±‚æ›´æ–°è®°å½•:', recordId, 'fields:', JSON.stringify(update.fields));
                const payload = {
                    records: [{
                        recordId: recordId,
                        fields: update.fields
                    }],
                    fieldKey: 'name'
                };
                console.log('ğŸ”„ è¯·æ±‚ä½“:', JSON.stringify(payload));
                const response = await fetch(`https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('ğŸ“¡ HTTPå“åº”çŠ¶æ€:', response.status, response.statusText);
                if (!response.ok) {
                    let errorText = '';
                    try {
                        errorText = await response.text();
                        console.error('âŒ HTTPé”™è¯¯å“åº”:', errorText);
                    } catch (e) {
                        console.error('âŒ æ— æ³•è¯»å–é”™è¯¯å“åº”:', e);
                    }
                    throw new Error(`HTTP ${response.status}: ${errorText || response.statusText || 'æ¥å£ä¸å­˜åœ¨æˆ–è¯·æ±‚å¤±è´¥'}`);
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    console.error('âŒ æ— æ³•è§£æJSONå“åº”:', e);
                    const responseText = await response.text();
                    console.error('âŒ å“åº”å†…å®¹:', responseText);
                    throw new Error('Vika APIå“åº”æ ¼å¼é”™è¯¯: ' + (responseText || 'ç©ºå“åº”'));
                }
                console.log('ğŸ“¡ Vika APIå“åº”:', JSON.stringify(data));
                if (!data.success) {
                    throw new Error(data.message || 'æ›´æ–°è®°å½•å¤±è´¥');
                }
                
                console.log('âœ… Vikaè®°å½•æ›´æ–°æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('âŒ æ›´æ–°Vikaè®°å½•å¤±è´¥:', error);
                console.error('âŒ é”™è¯¯è¯¦æƒ…:', error.message, error.stack);
                throw error;
            }
        }
        
        // æ ¹æ®æ—§æ¡ç å’Œæ ‡ç­¾ç»„æŸ¥æ‰¾è®°å½•ID
        async function findRecordIdByOldBarcode(oldBarcode, groupId) {
            try {
                console.log('ğŸ” æŸ¥æ‰¾è®°å½•ID - oldBarcode:', oldBarcode, 'groupId:', groupId);
                const response = await fetch('https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records?pageSize=100', {
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const inputBarcode = (oldBarcode || '').trim().toLowerCase();
                    const inputGroup = (groupId || '').trim();
                    console.log('ğŸ” æŸ¥æ‰¾æ¡ä»¶ - inputBarcode:', inputBarcode, 'inputGroup:', inputGroup);
                    
                    const record = data.data.records.find(record => {
                        const recOld = (record.fields['æ—§æ ‡ç­¾'] || '').toString().trim().toLowerCase();
                        const recGroup = (record.fields['æ ‡ç­¾ç»„'] || '').toString().trim();
                        const match = recOld === inputBarcode && recGroup === inputGroup;
                        if (match) {
                            console.log('âœ… æ‰¾åˆ°åŒ¹é…è®°å½• - recordId:', record.recordId, 'æ—§æ ‡ç­¾:', recOld, 'æ ‡ç­¾ç»„:', recGroup);
                        }
                        return match;
                    });
                    
                    if (!record) {
                        console.error('âŒ æœªæ‰¾åˆ°åŒ¹é…è®°å½•');
                        console.log('ğŸ“‹ å¯ç”¨çš„è®°å½•æ•°:', data.data.records.length);
                        // æ‰“å°å‰å‡ æ¡è®°å½•ç”¨äºè°ƒè¯•
                        const sampleRecords = data.data.records.slice(0, 3);
                        sampleRecords.forEach((r, i) => {
                            console.log(`ç¤ºä¾‹è®°å½• ${i+1}: æ—§æ ‡ç­¾=${(r.fields['æ—§æ ‡ç­¾'] || '').toString().trim()}, æ ‡ç­¾ç»„=${(r.fields['æ ‡ç­¾ç»„'] || '').toString().trim()}`);
                        });
                    }
                    
                    return record ? record.recordId : null;
                }
                console.error('âŒ Vika API è¯·æ±‚å¤±è´¥:', data);
                return null;
            } catch (error) {
                console.error('æŸ¥æ‰¾è®°å½•IDå¤±è´¥:', error);
                return null;
            }
        }
        
        // æ‰«ç æ‰“å°ä¸šåŠ¡é€»è¾‘
        async function findLabelByBarcode(oldBarcode) {
            // å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
            if (selectedLabelGroup && labelGroupsCache[selectedLabelGroup]) {
                const cache = labelGroupsCache[selectedLabelGroup];
                // å¤§å°å†™ä¸æ•æ„ŸæŸ¥æ‰¾
                for (const [key, value] of Object.entries(cache.labels)) {
                    if (key.toLowerCase() === oldBarcode.toLowerCase()) {
                        console.log('âœ… ä»ç¼“å­˜æ‰¾åˆ°æ ‡ç­¾æ•°æ®');
                        return value;
                    }
                }
            }
            
            // ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå®æ—¶æŸ¥è¯¢Vika
            console.log('ğŸ”„ ç¼“å­˜ä¸­æœªæ‰¾åˆ°ï¼Œå®æ—¶æŸ¥è¯¢Vika...');
            if (!selectedLabelGroup) {
                console.log('âŒ æœªé€‰æ‹©æ ‡ç­¾ç»„');
                return null;
            }
            
            try {
                const response = await fetch('https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records?pageSize=100', {
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const record = data.data.records.find(record => 
                        (record.fields['æ—§æ ‡ç­¾'] || '').toString().trim().toLowerCase() === oldBarcode.trim().toLowerCase() && 
                        (record.fields['æ ‡ç­¾ç»„'] || '').toString().trim() === selectedLabelGroup
                    );
                    
                    if (record) {
                        console.log('âœ… ä»Vikaæ‰¾åˆ°æ ‡ç­¾æ•°æ®:', record.fields);
                        const limitNum = (record.fields['æ¢æ ‡æ•°é‡'] == null || isNaN(Number(record.fields['æ¢æ ‡æ•°é‡']))) ? 1 : Number(record.fields['æ¢æ ‡æ•°é‡']);
                        // å…¼å®¹å­—æ®µåï¼šä¼˜å…ˆ"æ‰“å°æ•°é‡"ï¼Œå…¶æ¬¡"æ‰“å°æ¬¡æ•°"
                        const printedRaw = (record.fields.hasOwnProperty('æ‰“å°æ•°é‡') ? record.fields['æ‰“å°æ•°é‡'] : record.fields['æ‰“å°æ¬¡æ•°']);
                        const printedNum = (printedRaw == null || isNaN(Number(printedRaw))) ? 0 : Number(printedRaw);
                        const remaining = Math.max(limitNum - printedNum, 0);
                        const label = {
                            newBarcode: record.fields['æ–°æ ‡ç­¾'],
                            productName: record.fields['äº§å“åç§°'] || 'äº§å“',
                            description: record.fields['äº§å“æè¿°'] || 'äº§å“æè¿°',
                            count: remaining,
                            originalCount: limitNum,
                            printLimit: limitNum,
                            printedCount: printedNum
                        };
                        
                        return label;
                    }
                }
                console.log('âŒ åœ¨Vikaä¸­æœªæ‰¾åˆ°å¯¹åº”æ ‡ç­¾');
                return null;
            } catch (error) {
                console.error('å®æ—¶æŸ¥è¯¢Vikaå¤±è´¥:', error);
                return null;
            }
        }
        
        function generateZPL(template, data) {
            let zpl = template;
            
            // æ›¿æ¢å˜é‡
            zpl = zpl.replace(/\{\{barcode\}\}/g, data.barcode || '');
            zpl = zpl.replace(/\{\{product_description\}\}/g, data.product_description || '');
            zpl = zpl.replace(/\{\{product_name\}\}/g, data.product_name || '');
            
            return zpl;
        }
        
        function sendToPrinter(zplCode) {
            const printerConfig = localStorage.getItem('printerConfig');
            if (!printerConfig) {
                showStatus('è¯·å…ˆé…ç½®æ‰“å°æœºIPå’Œç«¯å£', false);
                return;
            }
            
            const config = JSON.parse(printerConfig);
            const ip = config.ip;
            const port = config.port;
            
            if (!ip || !port) {
                showStatus('è¯·å…ˆé…ç½®æ‰“å°æœºIPå’Œç«¯å£', false);
                return;
            }
            
            showStatus('æ­£åœ¨å‘é€åˆ°æ‰“å°æœº...', true);
            console.log('å‘é€æ‰“å° - IP:', ip, 'Port:', port);
            console.log('ZPLä»£ç :', zplCode);
            console.log('PrinterInterface å¯ç”¨:', !!window.PrinterInterface);
            
            // ä½¿ç”¨Androidæ¥å£å‘é€ZPLä»£ç 
            if (window.PrinterInterface) {
                console.log('è°ƒç”¨ Android æ¥å£å‘é€æ‰“å°');
                window.PrinterInterface.sendToPrinter(ip, port, zplCode);
            } else {
                console.log('PrinterInterface ä¸å¯ç”¨');
                showStatus('æ‰“å°æœºæ¥å£ä¸å¯ç”¨', false);
            }
        }
        
        async function printBarcode() {
            const barcode = document.getElementById('barcodeInput').value.trim();
            console.log('ğŸ” å¼€å§‹æ‰«ç æ‰“å°æµç¨‹ï¼Œè¾“å…¥æ¡ç :', barcode);
            
            if (!barcode) {
                console.log('âŒ æ¡ç ä¸ºç©º');
                showError('è¯·è¾“å…¥æ¡ç ');
                hideQueryResult();
                return;
            }
            
            if (!selectedLabelGroup) {
                console.log('âŒ æœªé€‰æ‹©æ ‡ç­¾ç»„');
                showError('è¯·å…ˆé€‰æ‹©æ ‡ç­¾ç»„');
                hideQueryResult();
                return;
            }
            
            console.log('ğŸ” æŸ¥æ‰¾æ ‡ç­¾é…ç½®ï¼Œæ ‡ç­¾ç»„:', selectedLabelGroup);
            // æŸ¥æ‰¾æ ‡ç­¾é…ç½®å¹¶æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
            const label = await findLabelByBarcode(barcode);
            if (!label) {
                console.log('âŒ æœªæ‰¾åˆ°å¯¹åº”çš„æ ‡ç­¾é…ç½®');
                showError('æœªæ‰¾åˆ°å¯¹åº”çš„æ ‡ç­¾é…ç½®');
                hideQueryResult();
                return;
            }
            
            // å…ˆæ˜¾ç¤ºæŸ¥è¯¢ç»“æœï¼ˆä¸ç®¡æ‰“å°æœºæ˜¯å¦è¿æ¥ï¼‰
            await showQueryResult(barcode);
            
            // æ£€æŸ¥æ‰“å°æœºè¿æ¥ï¼ˆåœ¨æŸ¥è¯¢æ˜¾ç¤ºä¹‹åï¼‰
            if (!printerConnected) {
                console.log('âŒ æ‰“å°æœºæœªè¿æ¥');
                showError('æ‰“å°æœºæœªè¿æ¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®');
                return; // ä¸éšè—æŸ¥è¯¢ç»“æœï¼Œåªæ˜¯æ˜¾ç¤ºé”™è¯¯
            }
            
            console.log('âœ… æ‰¾åˆ°æ ‡ç­¾é…ç½®:', label);
            // å…ˆè®¡ç®—å†æ‰“å°ï¼šåŸºäºä¸Šé™ä¸å·²æ‰“å°è®¡ç®—å‰©ä½™
            const limit = (typeof label.printLimit === 'number') ? label.printLimit : (typeof label.originalCount === 'number' ? label.originalCount : 1);
            const printed = (typeof label.printedCount === 'number') ? label.printedCount : ((typeof label.originalCount === 'number' && typeof label.count === 'number') ? (label.originalCount - label.count) : 0);
            const remainingBefore = Math.max(limit - printed, 0);
            if (remainingBefore <= 0) {
                console.log('âš ï¸ å¯æ‰“å°æ•°é‡ä¸º 0ï¼Œä¸æ‰“å°');
                showError('å¯æ‰“å°æ•°é‡ä¸º 0ï¼Œæ— æ³•æ‰“å°');
                // ä¸è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œï¼Œç›´æ¥è¿”å›
                hideQueryResult();
                return;
            }
            // æœ¬åœ°å…ˆ+1å¹¶æ›´æ–°ç¼“å­˜ï¼ˆä¿è¯æ‰“å°åå‰©ä½™ç«‹å³å¯è§ï¼‰
            label.printedCount = printed + 1;
            const remainingAfter = Math.max(limit - label.printedCount, 0);
            // æ¨å…¥å¾…åŒæ­¥ï¼ˆä»…è®°å½•å˜æ›´ï¼Œä¸ç«‹å³çº¿ä¸ŠåŠ 1ï¼ŒåŒæ­¥ç­–ç•¥ä¿æŒä¸å˜ï¼Œæ»¡é¢æ—¶å†å¼ºåˆ¶åŒæ­¥ï¼‰
            const existingIdx = pendingUpdates.findIndex(u => u.oldBarcode === barcode && u.groupId === selectedLabelGroup);
            const updatePayload = { groupId: selectedLabelGroup, oldBarcode: barcode, fields: { 'æ‰“å°æ•°é‡': label.printedCount } };
            if (existingIdx === -1) pendingUpdates.push(updatePayload); else pendingUpdates[existingIdx] = updatePayload;
            updatePendingSyncCount();
            // åŒæ­¥åˆ°ç¼“å­˜ç»“æ„çš„countï¼ˆä½¿ç”¨å¤§å°å†™ä¸æ•æ„ŸæŸ¥æ‰¾å®é™…é”®ï¼‰
            if (labelGroupsCache[selectedLabelGroup] && labelGroupsCache[selectedLabelGroup].labels) {
                const cache = labelGroupsCache[selectedLabelGroup].labels;
                // æ‰¾åˆ°ç¼“å­˜ä¸­çš„å®é™…é”®ï¼ˆå¤§å°å†™ä¸æ•æ„ŸåŒ¹é…ï¼‰
                let actualKey = null;
                for (const key of Object.keys(cache)) {
                    if (key.toLowerCase() === barcode.toLowerCase()) {
                        actualKey = key;
                        break;
                    }
                }
                if (actualKey && cache[actualKey]) {
                    cache[actualKey].count = remainingAfter;
                    cache[actualKey].printedCount = label.printedCount;
                    cache[actualKey].printLimit = limit;
                }
            }
            // æ›´æ–°labelå¯¹è±¡çš„countï¼Œä¾›æ˜¾ç¤ºä½¿ç”¨
            label.count = remainingAfter;
            
            showStatus('æ­£åœ¨æ‰“å°...', true);
            hideError(); // éšè—ä¹‹å‰çš„é”™è¯¯
            
            // ä½¿ç”¨æ¨¡æ¿è¿›è¡Œå®é™…æ‰“å°ï¼ˆåœ¨æœ¬åœ°çŠ¶æ€æ›´æ–°ä¹‹åï¼‰
            if (currentTemplate) {
                const printData = {
                    barcode: label.newBarcode,
                    product_description: label.description,
                    product_name: label.productName
                };
                
                const zplCode = generateZPL(currentTemplate.content, printData);
                console.log('ç”Ÿæˆçš„ZPLä»£ç :', zplCode);
                
                // å‘é€åˆ°æ‰“å°æœº
                sendToPrinter(zplCode);
                
                showStatus(`æ‰“å°å‘½ä»¤å·²å‘é€ï¼${label.productName} - ${label.newBarcode}`, true);
            } else {
                // å¦‚æœæ²¡æœ‰æ¨¡æ¿ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ‰“å°
                setTimeout(() => {
                    const success = Math.random() > 0.1;
                    
                    if (success) {
                        showStatus(`æ‰“å°æˆåŠŸï¼${label.productName} - ${label.newBarcode}`, true);
                    } else {
                        showError('æ‰“å°å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }, 2000);
            }
            
            // æ‰“å°å®Œæˆåï¼Œæ˜¾ç¤ºæ›´æ–°åçš„æŸ¥è¯¢ç»“æœï¼ˆæ˜¾ç¤ºæ‰“å°åçš„æ•°æ®ï¼‰
            await showQueryResult(barcode);
            
            // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡æ–°é€‰ä¸­
            document.getElementById('barcodeInput').value = '';
            document.getElementById('barcodeInput').focus();
        }
        
        // æ‰“å°æœºæµ‹è¯•ç»“æœå›è°ƒ
        function onPrinterTestResult(success, message) {
            if (success) {
                printerConnected = true;
                updateStatusDisplay();
                showStatus('æ‰“å°æœºè¿æ¥æˆåŠŸï¼', true);
            } else {
                printerConnected = false;
                updateStatusDisplay();
                showStatus('æ‰“å°æœºè¿æ¥å¤±è´¥ï¼š' + message, false);
            }
        }
        
        // æ‰“å°æœºå‘é€ç»“æœå›è°ƒ
        function onPrinterSendResult(success, message) {
            if (success) {
                showStatus('æ‰“å°å‘½ä»¤å‘é€æˆåŠŸï¼', true);
            } else {
                showStatus('å‘é€æ‰“å°å‘½ä»¤å¤±è´¥: ' + message, false);
            }
        }
        
        // æ¥æ”¶æ ‡ç­¾ç»„æ•°æ®çš„å›è°ƒå‡½æ•°
        function onLabelGroupsReceived(dataJson) {
            try {
                console.log('ğŸ“¡ æ”¶åˆ°Vika APIå“åº”:', dataJson.substring(0, 100));
                const data = JSON.parse(dataJson);
                var recordCount = (data && data.data && Array.isArray(data.data.records)) ? data.data.records.length : 0;
                console.log('ğŸ“Š è·å–åˆ°è®°å½•æ•°:', recordCount);
                
                if (data.success) {
                    // æŒ‰æ ‡ç­¾ç»„å­—æ®µåˆ†ç»„
                    const groupMap = new Map();
                    data.data.records.forEach(record => {
                        const groupName = record.fields['æ ‡ç­¾ç»„'];
                        if (groupName && !groupMap.has(groupName)) {
                            groupMap.set(groupName, {
                                id: groupName,
                                name: groupName,
                                description: `æ ‡ç­¾ç»„: ${groupName}`
                            });
                        }
                    });
                    
                    labelGroups = Array.from(groupMap.values());
                    console.log('âœ… æ ‡ç­¾ç»„æ›´æ–°æˆåŠŸï¼Œå…±' + labelGroups.length + 'ä¸ªåˆ†ç»„');
                    showStatus('æ ‡ç­¾ç»„è·å–æˆåŠŸï¼', true);
                } else {
                    throw new Error(data.message || 'è·å–æ ‡ç­¾ç»„å¤±è´¥');
                }
            } catch (error) {
                console.error('å¤„ç†æ ‡ç­¾ç»„æ•°æ®å¤±è´¥:', error);
                showStatus('å¤„ç†æ ‡ç­¾ç»„æ•°æ®å¤±è´¥: ' + error.message, false);
            }
        }
        
        async function fetchLabelGroupLabels(groupId) {
            try {
                const response = await fetch('https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records?pageSize=100', {
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    // ç­›é€‰æŒ‡å®šæ ‡ç­¾ç»„çš„è®°å½•
                    const groupRecords = data.data.records.filter(record => {
                        return record.fields['æ ‡ç­¾ç»„'] === groupId;
                    });
                    
                    // ä¿å­˜åˆ°ç¼“å­˜
                    var foundGroup = labelGroups.find(function(g){ return g.id === groupId; });
                    labelGroupsCache[groupId] = {
                        name: (foundGroup && foundGroup.name) ? foundGroup.name : '',
                        description: (foundGroup && foundGroup.description) ? foundGroup.description : '',
                        labels: {}
                    };
                    
                    // å¤„ç†æ ‡ç­¾æ•°æ®
                    groupRecords.forEach(record => {
                        const oldBarcode = record.fields['æ—§æ ‡ç­¾'];
                        const newBarcode = record.fields['æ–°æ ‡ç­¾'];
                        // æ•°å€¼åŒ–ï¼šæ¢æ ‡æ•°é‡=ä¸Šé™ï¼›æ‰“å°æ¬¡æ•°=å·²æ‰“å°
                        const limitNum = (record.fields['æ¢æ ‡æ•°é‡'] == null || isNaN(Number(record.fields['æ¢æ ‡æ•°é‡']))) ? 1 : Number(record.fields['æ¢æ ‡æ•°é‡']);
                        // å…¼å®¹å­—æ®µåï¼šä¼˜å…ˆ"æ‰“å°æ•°é‡"ï¼Œå…¶æ¬¡"æ‰“å°æ¬¡æ•°"
                        const printedRaw = (record.fields.hasOwnProperty('æ‰“å°æ•°é‡') ? record.fields['æ‰“å°æ•°é‡'] : record.fields['æ‰“å°æ¬¡æ•°']);
                        const printedNum = (printedRaw == null || isNaN(Number(printedRaw))) ? 0 : Number(printedRaw);
                        const remaining = Math.max(limitNum - printedNum, 0);
                        if (oldBarcode && newBarcode) {
                            labelGroupsCache[groupId].labels[oldBarcode] = {
                                newBarcode: newBarcode,
                                productName: record.fields['äº§å“åç§°'] || 'äº§å“',
                                description: record.fields['äº§å“æè¿°'] || 'äº§å“æè¿°',
                                // å…¼å®¹ç°æœ‰ç»“æ„ï¼šcount ç”¨"å‰©ä½™æ•°é‡"ï¼ŒoriginalCount ç”¨"æ¢æ ‡æ•°é‡"
                                count: remaining,
                                originalCount: limitNum,
                                // é¢å¤–å­˜å‚¨ï¼Œä¾›åç»­é€»è¾‘ä½¿ç”¨
                                printLimit: limitNum,
                                printedCount: printedNum
                            };
                        }
                    });
                    
                    return true;
                } else {
                    showStatus('è·å–æ ‡ç­¾æ•°æ®å¤±è´¥: ' + data.message, false);
                    return false;
                }
            } catch (error) {
                console.error('è·å–æ ‡ç­¾æ•°æ®å¤±è´¥:', error);
                showStatus('è·å–æ ‡ç­¾æ•°æ®å¤±è´¥: ' + error.message, false);
                return false;
            }
        }
        
        // æ‰“å¼€è®¾ç½®é¡µé¢
        function openSettings() {
            // è·³è½¬åˆ°è®¾ç½®é¡µé¢
            window.location.href = 'file:///android_asset/index.html';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', async function() {
            showStatus('åº”ç”¨å·²å¯åŠ¨', true);
            updateStatusDisplay();
            
            // ä»localStorageåŠ è½½é…ç½®
            const printerConfig = localStorage.getItem('printerConfig');
            if (printerConfig) {
                const config = JSON.parse(printerConfig);
                if (config.ip && config.port) {
                    // æµ‹è¯•æ‰“å°æœºè¿æ¥çŠ¶æ€
                    if (window.PrinterInterface && window.PrinterInterface.testPrinterConnection) {
                        window.PrinterInterface.testPrinterConnection(config.ip, config.port);
                    }
                }
            }
            
            // åŠ è½½æ ‡ç­¾ç»„ï¼ˆå¦‚æœAndroidæ¥å£å¯ç”¨ï¼‰
            if (window.PrinterInterface && window.PrinterInterface.fetchLabelGroups) {
                window.PrinterInterface.fetchLabelGroups();
            }
            
            // åŠ è½½æ‰“å°æ¨¡æ¿
            const savedTemplate = localStorage.getItem('printTemplate');
            if (savedTemplate) {
                const template = JSON.parse(savedTemplate);
                currentTemplate = template;
                console.log('æ¨¡æ¿åŠ è½½æˆåŠŸï¼');
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ¨¡æ¿ï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿
                currentTemplate = {
                    name: 'ZP621æ ‡å‡†æ¨¡æ¿',
                    content: `^XA
^PW400
^LL300
^CF0,20

; === æ¡ç åŒºåŸŸï¼ˆå±…ä¸­ï¼‰ ===
^FO40,20
^BY2,2,100
^BCN,100,Y,N,N
^FD{{barcode}}^FS

; === äº§å“æè¿°ï¼ˆå·¦å¯¹é½ï¼Œè‡ªåŠ¨æ¢è¡Œå¤šè¡Œï¼‰ ===
^CFA,20
^FO60,200
^FB320,4,0,L,0
^FD{{product_description}}^FS

; === å›ºå®šçŠ¶æ€è¡Œï¼ˆå·¦å¯¹é½ï¼‰ ===
^CF0,22
^FO60,280^FDNew^FS

^XZ`
                };
                console.log('ä½¿ç”¨é»˜è®¤æ¨¡æ¿');
            }
            
            // ä»localStorageåŠ è½½å·²é€‰æ‹©çš„æ ‡ç­¾ç»„
            const savedLabelGroup = localStorage.getItem('selectedLabelGroup');
            if (savedLabelGroup) {
                selectedLabelGroup = savedLabelGroup;
                // å¦‚æœæ ‡ç­¾ç»„å·²é€‰æ‹©ï¼ŒåŠ è½½æ ‡ç­¾æ•°æ®
                if (selectedLabelGroup) {
                    await fetchLabelGroupLabels(selectedLabelGroup);
                }
            }
        });
    </script>
</body>
</html>
