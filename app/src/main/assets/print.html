<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZAP 标签打印</title>
    <style>
        body {
            margin: 0;
            padding: 5px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #007bff;
            color: white;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .settings-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .page {
            padding: 8px;
        }
        
        .scan-section {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .scan-section h3 {
            margin-top: 0;
            color: #666;
        }
        
        .scan-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .scan-input-container input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ccc;
            border-radius: 5px;
            font-size: 18px;
            font-family: monospace;
            text-align: center;
            box-sizing: border-box;
        }
        
        .scan-input-container input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .scan-input-container button {
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .scan-input-container button:hover {
            background: #0056b3;
        }
        
        .error-section {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 3px;
            border: 1px solid #f5c6cb;
            font-size: 14px;
        }
        
        .error-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .error-icon {
            font-size: 1.2rem;
        }
        
        .error-close {
            background: none;
            border: none;
            color: #721c24;
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: auto;
        }
        
        .query-result-section {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #28a745;
            border-radius: 5px;
            background: #d4edda;
        }
        
        .query-result-section h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #155724;
            font-size: 1rem;
        }
        
        .query-result-content {
            font-size: 14px;
            color: #155724;
        }
        
        .query-result-item {
            margin: 5px 0;
            padding: 5px;
            background: rgba(255,255,255,0.5);
            border-radius: 3px;
        }
        
        .query-result-label {
            font-weight: bold;
            display: inline-block;
            min-width: 80px;
        }
        
        .status-indicators {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .status-icon {
            font-size: 1rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background: #28a745;
        }
        
        .status-dot.offline {
            background: #dc3545;
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>EZAP 标签打印</h1>
            <button class="settings-btn" id="topRightBtn" onclick="openSettings()" title="设置">⚙️</button>
        </div>
        
        <!-- 打印业务页面 -->
        <div class="page">
            <!-- 扫码输入区域 -->
            <div class="scan-section">
                <h3>扫码打印</h3>
                <div class="scan-input-container">
                    <input type="text" id="barcodeInput" placeholder="扫描或输入条码" oninput="onBarcodeInput()" onkeypress="onBarcodeKeyPress(event)">
                    <button onclick="printBarcode()">打印</button>
                </div>
            </div>
            
            <!-- 异常显示区域 -->
            <div id="errorSection" class="error-section" style="display: none;">
                <div class="error-content">
                    <span class="error-icon">⚠️</span>
                    <span id="errorMessage">错误信息</span>
                    <button class="error-close" onclick="hideError()">×</button>
                </div>
            </div>
            
            <!-- 查询结果显示区域 -->
            <div id="queryResultSection" class="query-result-section" style="display: none;">
                <h3>查询结果</h3>
                <div id="queryResultContent" class="query-result-content">
                    <!-- 查询结果将在这里显示 -->
                </div>
            </div>
            
            <!-- 左下角状态指示器 -->
            <div class="status-indicators">
                <div class="status-indicator" title="打印机状态">
                    <span class="status-icon">🖨️</span>
                    <span id="printerStatus" class="status-dot offline"></span>
                </div>
            </div>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
    </div>

    <script>
        // 全局变量
        let printerConnected = false;
        
        // 标签组相关变量
        let labelGroups = [];
        let selectedLabelGroup = null;
        let labelGroupsCache = {};
        let pendingUpdates = [];
        
        // 模板相关变量
        let currentTemplate = null;
        
        function showStatus(message, isSuccess) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isSuccess ? 'success' : 'error');
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }
        
        function updateStatusDisplay() {
            const printerStatus = document.getElementById('printerStatus');
            
            // 更新打印机状态
            if (printerConnected) {
                printerStatus.className = 'status-dot online';
            } else {
                printerStatus.className = 'status-dot offline';
            }
        }
        
        function onBarcodeInput() {
            // 正常输入时不选中内容，保持正常输入体验
        }
        
        function onBarcodeKeyPress(event) {
            // 回车键直接打印
            if (event.key === 'Enter') {
                event.preventDefault();
                // 回车时选中所有内容，方便扫码枪使用
                const input = document.getElementById('barcodeInput');
                input.select();
                printBarcode();
            }
        }
        
        // 错误显示功能
        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorSection.style.display = 'block';
        }
        
        function hideError() {
            const errorSection = document.getElementById('errorSection');
            errorSection.style.display = 'none';
        }
        
        async function showQueryResult(barcode) {
            const queryResultSection = document.getElementById('queryResultSection');
            const queryResultContent = document.getElementById('queryResultContent');
            
            // 清空之前的内容
            queryResultContent.innerHTML = '';
            
            // 显示输入条码
            queryResultContent.innerHTML += `
                <div class="query-result-item">
                    <span class="query-result-label">输入条码:</span>
                    <span>${barcode}</span>
                </div>
            `;
            
            // 显示标签组信息
            if (selectedLabelGroup) {
                const group = labelGroups.find(g => g.id === selectedLabelGroup);
                queryResultContent.innerHTML += `
                    <div class="query-result-item">
                        <span class="query-result-label">标签组:</span>
                        <span>${group ? group.name : selectedLabelGroup}</span>
                    </div>
                `;
            } else {
                queryResultContent.innerHTML += `
                    <div class="query-result-item">
                        <span class="query-result-label">标签组:</span>
                        <span style="color: #dc3545;">未选择</span>
                    </div>
                `;
            }
            
            // 查找标签配置
            if (selectedLabelGroup) {
                const label = await findLabelByBarcode(barcode);
                if (label) {
                    queryResultContent.innerHTML += `
                        <div class="query-result-item">
                            <span class="query-result-label">新条码:</span>
                            <span>${label.newBarcode}</span>
                        </div>
                        <div class="query-result-item">
                            <span class="query-result-label">产品名称:</span>
                            <span>${label.productName}</span>
                        </div>
                        <div class="query-result-item">
                            <span class="query-result-label">剩余数量:</span>
                            <span style="color: ${label.count > 0 ? '#28a745' : '#dc3545'};">${label.count === -1 ? '无限' : label.count}</span>
                        </div>
                    `;
                } else {
                    queryResultContent.innerHTML += `
                        <div class="query-result-item">
                            <span class="query-result-label">查询结果:</span>
                            <span style="color: #dc3545;">未找到对应的标签配置</span>
                        </div>
                    `;
                }
            } else {
                queryResultContent.innerHTML += `
                    <div class="query-result-item">
                        <span class="query-result-label">查询结果:</span>
                        <span style="color: #dc3545;">请先选择标签组</span>
                    </div>
                `;
            }
            
            // 显示查询结果区域
            queryResultSection.style.display = 'block';
        }
        
        function hideQueryResult() {
            const queryResultSection = document.getElementById('queryResultSection');
            queryResultSection.style.display = 'none';
        }
        
        function updatePendingSyncCount() {
            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) {
                syncBtn.disabled = pendingUpdates.length === 0;
            }
        }
        
        // 直接调用Vika API更新记录
        async function updateVikaRecord(update) {
            try {
                console.log('🔄 开始更新Vika记录:', JSON.stringify(update));
                // 先获取记录ID
                const recordId = await findRecordIdByOldBarcode(update.oldBarcode, update.groupId);
                console.log('📋 查找到的记录ID:', recordId);
                if (!recordId) {
                    throw new Error(`未找到记录: 旧条码=${update.oldBarcode}, 标签组=${update.groupId}`);
                }
                
                // 更新记录 - 使用 Vika API 单条更新格式（批量格式）
                console.log('🔄 发送PATCH请求更新记录:', recordId, 'fields:', JSON.stringify(update.fields));
                const payload = {
                    records: [{
                        recordId: recordId,
                        fields: update.fields
                    }],
                    fieldKey: 'name'
                };
                console.log('🔄 请求体:', JSON.stringify(payload));
                const response = await fetch(`https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('📡 HTTP响应状态:', response.status, response.statusText);
                if (!response.ok) {
                    let errorText = '';
                    try {
                        errorText = await response.text();
                        console.error('❌ HTTP错误响应:', errorText);
                    } catch (e) {
                        console.error('❌ 无法读取错误响应:', e);
                    }
                    throw new Error(`HTTP ${response.status}: ${errorText || response.statusText || '接口不存在或请求失败'}`);
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    console.error('❌ 无法解析JSON响应:', e);
                    const responseText = await response.text();
                    console.error('❌ 响应内容:', responseText);
                    throw new Error('Vika API响应格式错误: ' + (responseText || '空响应'));
                }
                console.log('📡 Vika API响应:', JSON.stringify(data));
                if (!data.success) {
                    throw new Error(data.message || '更新记录失败');
                }
                
                console.log('✅ Vika记录更新成功');
                return true;
            } catch (error) {
                console.error('❌ 更新Vika记录失败:', error);
                console.error('❌ 错误详情:', error.message, error.stack);
                throw error;
            }
        }
        
        // 根据旧条码和标签组查找记录ID
        async function findRecordIdByOldBarcode(oldBarcode, groupId) {
            try {
                console.log('🔍 查找记录ID - oldBarcode:', oldBarcode, 'groupId:', groupId);
                const response = await fetch('https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records?pageSize=100', {
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const inputBarcode = (oldBarcode || '').trim().toLowerCase();
                    const inputGroup = (groupId || '').trim();
                    console.log('🔍 查找条件 - inputBarcode:', inputBarcode, 'inputGroup:', inputGroup);
                    
                    const record = data.data.records.find(record => {
                        const recOld = (record.fields['旧标签'] || '').toString().trim().toLowerCase();
                        const recGroup = (record.fields['标签组'] || '').toString().trim();
                        const match = recOld === inputBarcode && recGroup === inputGroup;
                        if (match) {
                            console.log('✅ 找到匹配记录 - recordId:', record.recordId, '旧标签:', recOld, '标签组:', recGroup);
                        }
                        return match;
                    });
                    
                    if (!record) {
                        console.error('❌ 未找到匹配记录');
                        console.log('📋 可用的记录数:', data.data.records.length);
                        // 打印前几条记录用于调试
                        const sampleRecords = data.data.records.slice(0, 3);
                        sampleRecords.forEach((r, i) => {
                            console.log(`示例记录 ${i+1}: 旧标签=${(r.fields['旧标签'] || '').toString().trim()}, 标签组=${(r.fields['标签组'] || '').toString().trim()}`);
                        });
                    }
                    
                    return record ? record.recordId : null;
                }
                console.error('❌ Vika API 请求失败:', data);
                return null;
            } catch (error) {
                console.error('查找记录ID失败:', error);
                return null;
            }
        }
        
        // 扫码打印业务逻辑
        async function findLabelByBarcode(oldBarcode) {
            // 先查本地缓存
            if (selectedLabelGroup && labelGroupsCache[selectedLabelGroup]) {
                const cache = labelGroupsCache[selectedLabelGroup];
                // 大小写不敏感查找
                for (const [key, value] of Object.entries(cache.labels)) {
                    if (key.toLowerCase() === oldBarcode.toLowerCase()) {
                        console.log('✅ 从缓存找到标签数据');
                        return value;
                    }
                }
            }
            
            // 缓存中没有，实时查询Vika
            console.log('🔄 缓存中未找到，实时查询Vika...');
            if (!selectedLabelGroup) {
                console.log('❌ 未选择标签组');
                return null;
            }
            
            try {
                const response = await fetch('https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records?pageSize=100', {
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const record = data.data.records.find(record => 
                        (record.fields['旧标签'] || '').toString().trim().toLowerCase() === oldBarcode.trim().toLowerCase() && 
                        (record.fields['标签组'] || '').toString().trim() === selectedLabelGroup
                    );
                    
                    if (record) {
                        console.log('✅ 从Vika找到标签数据:', record.fields);
                        const limitNum = (record.fields['换标数量'] == null || isNaN(Number(record.fields['换标数量']))) ? 1 : Number(record.fields['换标数量']);
                        // 兼容字段名：优先"打印数量"，其次"打印次数"
                        const printedRaw = (record.fields.hasOwnProperty('打印数量') ? record.fields['打印数量'] : record.fields['打印次数']);
                        const printedNum = (printedRaw == null || isNaN(Number(printedRaw))) ? 0 : Number(printedRaw);
                        const remaining = Math.max(limitNum - printedNum, 0);
                        const label = {
                            newBarcode: record.fields['新标签'],
                            productName: record.fields['产品名称'] || '产品',
                            description: record.fields['产品描述'] || '产品描述',
                            count: remaining,
                            originalCount: limitNum,
                            printLimit: limitNum,
                            printedCount: printedNum
                        };
                        
                        return label;
                    }
                }
                console.log('❌ 在Vika中未找到对应标签');
                return null;
            } catch (error) {
                console.error('实时查询Vika失败:', error);
                return null;
            }
        }
        
        function generateZPL(template, data) {
            let zpl = template;
            
            // 替换变量
            zpl = zpl.replace(/\{\{barcode\}\}/g, data.barcode || '');
            zpl = zpl.replace(/\{\{product_description\}\}/g, data.product_description || '');
            zpl = zpl.replace(/\{\{product_name\}\}/g, data.product_name || '');
            
            return zpl;
        }
        
        function sendToPrinter(zplCode) {
            const printerConfig = localStorage.getItem('printerConfig');
            if (!printerConfig) {
                showStatus('请先配置打印机IP和端口', false);
                return;
            }
            
            const config = JSON.parse(printerConfig);
            const ip = config.ip;
            const port = config.port;
            
            if (!ip || !port) {
                showStatus('请先配置打印机IP和端口', false);
                return;
            }
            
            showStatus('正在发送到打印机...', true);
            console.log('发送打印 - IP:', ip, 'Port:', port);
            console.log('ZPL代码:', zplCode);
            console.log('PrinterInterface 可用:', !!window.PrinterInterface);
            
            // 使用Android接口发送ZPL代码
            if (window.PrinterInterface) {
                console.log('调用 Android 接口发送打印');
                window.PrinterInterface.sendToPrinter(ip, port, zplCode);
            } else {
                console.log('PrinterInterface 不可用');
                showStatus('打印机接口不可用', false);
            }
        }
        
        async function printBarcode() {
            const barcode = document.getElementById('barcodeInput').value.trim();
            console.log('🔍 开始扫码打印流程，输入条码:', barcode);
            
            if (!barcode) {
                console.log('❌ 条码为空');
                showError('请输入条码');
                hideQueryResult();
                return;
            }
            
            if (!selectedLabelGroup) {
                console.log('❌ 未选择标签组');
                showError('请先选择标签组');
                hideQueryResult();
                return;
            }
            
            console.log('🔍 查找标签配置，标签组:', selectedLabelGroup);
            // 查找标签配置并显示查询结果
            const label = await findLabelByBarcode(barcode);
            if (!label) {
                console.log('❌ 未找到对应的标签配置');
                showError('未找到对应的标签配置');
                hideQueryResult();
                return;
            }
            
            // 先显示查询结果（不管打印机是否连接）
            await showQueryResult(barcode);
            
            // 检查打印机连接（在查询显示之后）
            if (!printerConnected) {
                console.log('❌ 打印机未连接');
                showError('打印机未连接，请检查设置');
                return; // 不隐藏查询结果，只是显示错误
            }
            
            console.log('✅ 找到标签配置:', label);
            // 先计算再打印：基于上限与已打印计算剩余
            const limit = (typeof label.printLimit === 'number') ? label.printLimit : (typeof label.originalCount === 'number' ? label.originalCount : 1);
            const printed = (typeof label.printedCount === 'number') ? label.printedCount : ((typeof label.originalCount === 'number' && typeof label.count === 'number') ? (label.originalCount - label.count) : 0);
            const remainingBefore = Math.max(limit - printed, 0);
            if (remainingBefore <= 0) {
                console.log('⚠️ 可打印数量为 0，不打印');
                showError('可打印数量为 0，无法打印');
                // 不进行任何同步操作，直接返回
                hideQueryResult();
                return;
            }
            // 本地先+1并更新缓存（保证打印后剩余立即可见）
            label.printedCount = printed + 1;
            const remainingAfter = Math.max(limit - label.printedCount, 0);
            // 推入待同步（仅记录变更，不立即线上加1，同步策略保持不变，满额时再强制同步）
            const existingIdx = pendingUpdates.findIndex(u => u.oldBarcode === barcode && u.groupId === selectedLabelGroup);
            const updatePayload = { groupId: selectedLabelGroup, oldBarcode: barcode, fields: { '打印数量': label.printedCount } };
            if (existingIdx === -1) pendingUpdates.push(updatePayload); else pendingUpdates[existingIdx] = updatePayload;
            updatePendingSyncCount();
            // 同步到缓存结构的count（使用大小写不敏感查找实际键）
            if (labelGroupsCache[selectedLabelGroup] && labelGroupsCache[selectedLabelGroup].labels) {
                const cache = labelGroupsCache[selectedLabelGroup].labels;
                // 找到缓存中的实际键（大小写不敏感匹配）
                let actualKey = null;
                for (const key of Object.keys(cache)) {
                    if (key.toLowerCase() === barcode.toLowerCase()) {
                        actualKey = key;
                        break;
                    }
                }
                if (actualKey && cache[actualKey]) {
                    cache[actualKey].count = remainingAfter;
                    cache[actualKey].printedCount = label.printedCount;
                    cache[actualKey].printLimit = limit;
                }
            }
            // 更新label对象的count，供显示使用
            label.count = remainingAfter;
            
            showStatus('正在打印...', true);
            hideError(); // 隐藏之前的错误
            
            // 使用模板进行实际打印（在本地状态更新之后）
            if (currentTemplate) {
                const printData = {
                    barcode: label.newBarcode,
                    product_description: label.description,
                    product_name: label.productName
                };
                
                const zplCode = generateZPL(currentTemplate.content, printData);
                console.log('生成的ZPL代码:', zplCode);
                
                // 发送到打印机
                sendToPrinter(zplCode);
                
                showStatus(`打印命令已发送！${label.productName} - ${label.newBarcode}`, true);
            } else {
                // 如果没有模板，使用模拟打印
                setTimeout(() => {
                    const success = Math.random() > 0.1;
                    
                    if (success) {
                        showStatus(`打印成功！${label.productName} - ${label.newBarcode}`, true);
                    } else {
                        showError('打印失败，请重试');
                    }
                }, 2000);
            }
            
            // 打印完成后，显示更新后的查询结果（显示打印后的数据）
            await showQueryResult(barcode);
            
            // 清空输入框并重新选中
            document.getElementById('barcodeInput').value = '';
            document.getElementById('barcodeInput').focus();
        }
        
        // 打印机测试结果回调
        function onPrinterTestResult(success, message) {
            if (success) {
                printerConnected = true;
                updateStatusDisplay();
                showStatus('打印机连接成功！', true);
            } else {
                printerConnected = false;
                updateStatusDisplay();
                showStatus('打印机连接失败：' + message, false);
            }
        }
        
        // 打印机发送结果回调
        function onPrinterSendResult(success, message) {
            if (success) {
                showStatus('打印命令发送成功！', true);
            } else {
                showStatus('发送打印命令失败: ' + message, false);
            }
        }
        
        // 接收标签组数据的回调函数
        function onLabelGroupsReceived(dataJson) {
            try {
                console.log('📡 收到Vika API响应:', dataJson.substring(0, 100));
                const data = JSON.parse(dataJson);
                var recordCount = (data && data.data && Array.isArray(data.data.records)) ? data.data.records.length : 0;
                console.log('📊 获取到记录数:', recordCount);
                
                if (data.success) {
                    // 按标签组字段分组
                    const groupMap = new Map();
                    data.data.records.forEach(record => {
                        const groupName = record.fields['标签组'];
                        if (groupName && !groupMap.has(groupName)) {
                            groupMap.set(groupName, {
                                id: groupName,
                                name: groupName,
                                description: `标签组: ${groupName}`
                            });
                        }
                    });
                    
                    labelGroups = Array.from(groupMap.values());
                    console.log('✅ 标签组更新成功，共' + labelGroups.length + '个分组');
                    showStatus('标签组获取成功！', true);
                } else {
                    throw new Error(data.message || '获取标签组失败');
                }
            } catch (error) {
                console.error('处理标签组数据失败:', error);
                showStatus('处理标签组数据失败: ' + error.message, false);
            }
        }
        
        async function fetchLabelGroupLabels(groupId) {
            try {
                const response = await fetch('https://api.vika.cn/fusion/v1/datasheets/dst0SSLLF0l2Y4dHcw/records?pageSize=100', {
                    headers: {
                        'Authorization': 'Bearer uskI2CEJkCSNZNU2KArVUTU',
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    // 筛选指定标签组的记录
                    const groupRecords = data.data.records.filter(record => {
                        return record.fields['标签组'] === groupId;
                    });
                    
                    // 保存到缓存
                    var foundGroup = labelGroups.find(function(g){ return g.id === groupId; });
                    labelGroupsCache[groupId] = {
                        name: (foundGroup && foundGroup.name) ? foundGroup.name : '',
                        description: (foundGroup && foundGroup.description) ? foundGroup.description : '',
                        labels: {}
                    };
                    
                    // 处理标签数据
                    groupRecords.forEach(record => {
                        const oldBarcode = record.fields['旧标签'];
                        const newBarcode = record.fields['新标签'];
                        // 数值化：换标数量=上限；打印次数=已打印
                        const limitNum = (record.fields['换标数量'] == null || isNaN(Number(record.fields['换标数量']))) ? 1 : Number(record.fields['换标数量']);
                        // 兼容字段名：优先"打印数量"，其次"打印次数"
                        const printedRaw = (record.fields.hasOwnProperty('打印数量') ? record.fields['打印数量'] : record.fields['打印次数']);
                        const printedNum = (printedRaw == null || isNaN(Number(printedRaw))) ? 0 : Number(printedRaw);
                        const remaining = Math.max(limitNum - printedNum, 0);
                        if (oldBarcode && newBarcode) {
                            labelGroupsCache[groupId].labels[oldBarcode] = {
                                newBarcode: newBarcode,
                                productName: record.fields['产品名称'] || '产品',
                                description: record.fields['产品描述'] || '产品描述',
                                // 兼容现有结构：count 用"剩余数量"，originalCount 用"换标数量"
                                count: remaining,
                                originalCount: limitNum,
                                // 额外存储，供后续逻辑使用
                                printLimit: limitNum,
                                printedCount: printedNum
                            };
                        }
                    });
                    
                    return true;
                } else {
                    showStatus('获取标签数据失败: ' + data.message, false);
                    return false;
                }
            } catch (error) {
                console.error('获取标签数据失败:', error);
                showStatus('获取标签数据失败: ' + error.message, false);
                return false;
            }
        }
        
        // 打开设置页面
        function openSettings() {
            // 跳转到设置页面
            window.location.href = 'file:///android_asset/index.html';
        }
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', async function() {
            showStatus('应用已启动', true);
            updateStatusDisplay();
            
            // 从localStorage加载配置
            const printerConfig = localStorage.getItem('printerConfig');
            if (printerConfig) {
                const config = JSON.parse(printerConfig);
                if (config.ip && config.port) {
                    // 测试打印机连接状态
                    if (window.PrinterInterface && window.PrinterInterface.testPrinterConnection) {
                        window.PrinterInterface.testPrinterConnection(config.ip, config.port);
                    }
                }
            }
            
            // 加载标签组（如果Android接口可用）
            if (window.PrinterInterface && window.PrinterInterface.fetchLabelGroups) {
                window.PrinterInterface.fetchLabelGroups();
            }
            
            // 加载打印模板
            const savedTemplate = localStorage.getItem('printTemplate');
            if (savedTemplate) {
                const template = JSON.parse(savedTemplate);
                currentTemplate = template;
                console.log('模板加载成功！');
            } else {
                // 如果没有保存的模板，使用默认模板
                currentTemplate = {
                    name: 'ZP621标准模板',
                    content: `^XA
^PW400
^LL300
^CF0,20

; === 条码区域（居中） ===
^FO40,20
^BY2,2,100
^BCN,100,Y,N,N
^FD{{barcode}}^FS

; === 产品描述（左对齐，自动换行多行） ===
^CFA,20
^FO60,200
^FB320,4,0,L,0
^FD{{product_description}}^FS

; === 固定状态行（左对齐） ===
^CF0,22
^FO60,280^FDNew^FS

^XZ`
                };
                console.log('使用默认模板');
            }
            
            // 从localStorage加载已选择的标签组
            const savedLabelGroup = localStorage.getItem('selectedLabelGroup');
            if (savedLabelGroup) {
                selectedLabelGroup = savedLabelGroup;
                // 如果标签组已选择，加载标签数据
                if (selectedLabelGroup) {
                    await fetchLabelGroupLabels(selectedLabelGroup);
                }
            }
        });
    </script>
</body>
</html>
